<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机面试指北</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="计算机面试指北">
    
    <link rel="preload" href="/CS-Note/assets/css/0.styles.37b6130a.css" as="style"><link rel="preload" href="/CS-Note/assets/js/app.499d959b.js" as="script"><link rel="preload" href="/CS-Note/assets/js/2.3a0ab2ea.js" as="script"><link rel="preload" href="/CS-Note/assets/js/1.2a19e319.js" as="script"><link rel="preload" href="/CS-Note/assets/js/34.09c983b1.js" as="script"><link rel="prefetch" href="/CS-Note/assets/js/10.d51ac22e.js"><link rel="prefetch" href="/CS-Note/assets/js/11.b53fe42a.js"><link rel="prefetch" href="/CS-Note/assets/js/12.7aa00c78.js"><link rel="prefetch" href="/CS-Note/assets/js/13.67223a8e.js"><link rel="prefetch" href="/CS-Note/assets/js/14.207a62d8.js"><link rel="prefetch" href="/CS-Note/assets/js/15.13447313.js"><link rel="prefetch" href="/CS-Note/assets/js/16.5f3d6fd5.js"><link rel="prefetch" href="/CS-Note/assets/js/17.56e70d25.js"><link rel="prefetch" href="/CS-Note/assets/js/18.f14668a4.js"><link rel="prefetch" href="/CS-Note/assets/js/19.fd36e329.js"><link rel="prefetch" href="/CS-Note/assets/js/20.ac1cf63f.js"><link rel="prefetch" href="/CS-Note/assets/js/21.c82e808b.js"><link rel="prefetch" href="/CS-Note/assets/js/22.8a129fa2.js"><link rel="prefetch" href="/CS-Note/assets/js/23.4bc57570.js"><link rel="prefetch" href="/CS-Note/assets/js/24.73b21b26.js"><link rel="prefetch" href="/CS-Note/assets/js/25.b8611692.js"><link rel="prefetch" href="/CS-Note/assets/js/26.a296c369.js"><link rel="prefetch" href="/CS-Note/assets/js/27.42b29ccc.js"><link rel="prefetch" href="/CS-Note/assets/js/28.f5d9ff11.js"><link rel="prefetch" href="/CS-Note/assets/js/29.734fa758.js"><link rel="prefetch" href="/CS-Note/assets/js/3.9d4db8bf.js"><link rel="prefetch" href="/CS-Note/assets/js/30.17548d71.js"><link rel="prefetch" href="/CS-Note/assets/js/31.3dc09066.js"><link rel="prefetch" href="/CS-Note/assets/js/32.0fe7da6f.js"><link rel="prefetch" href="/CS-Note/assets/js/33.a522da37.js"><link rel="prefetch" href="/CS-Note/assets/js/35.e76434f5.js"><link rel="prefetch" href="/CS-Note/assets/js/36.39026a8c.js"><link rel="prefetch" href="/CS-Note/assets/js/37.e0c6270e.js"><link rel="prefetch" href="/CS-Note/assets/js/38.a3b88467.js"><link rel="prefetch" href="/CS-Note/assets/js/39.cbbe4c99.js"><link rel="prefetch" href="/CS-Note/assets/js/4.eed64932.js"><link rel="prefetch" href="/CS-Note/assets/js/40.32d35e6a.js"><link rel="prefetch" href="/CS-Note/assets/js/41.96ec4146.js"><link rel="prefetch" href="/CS-Note/assets/js/42.1c7206ce.js"><link rel="prefetch" href="/CS-Note/assets/js/43.9cf3acc6.js"><link rel="prefetch" href="/CS-Note/assets/js/44.de1adacc.js"><link rel="prefetch" href="/CS-Note/assets/js/45.0d47c93a.js"><link rel="prefetch" href="/CS-Note/assets/js/46.6109a5cc.js"><link rel="prefetch" href="/CS-Note/assets/js/47.e3ee1a02.js"><link rel="prefetch" href="/CS-Note/assets/js/48.7c856d25.js"><link rel="prefetch" href="/CS-Note/assets/js/49.08d863fe.js"><link rel="prefetch" href="/CS-Note/assets/js/5.8ea92bac.js"><link rel="prefetch" href="/CS-Note/assets/js/50.b38b6f84.js"><link rel="prefetch" href="/CS-Note/assets/js/51.eb35dbda.js"><link rel="prefetch" href="/CS-Note/assets/js/6.7df2cbe2.js"><link rel="prefetch" href="/CS-Note/assets/js/7.e0fadba1.js"><link rel="prefetch" href="/CS-Note/assets/js/vendors~docsearch.2493936b.js">
    <link rel="stylesheet" href="/CS-Note/assets/css/0.styles.37b6130a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CS-Note/" class="home-link router-link-active"><img src="images/hero.png" alt="计算机面试指北" class="logo"> <span class="site-name can-hide">计算机面试指北</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CS-Note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java并发.html" class="nav-link">
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java高级.html" class="nav-link">
  Java高级
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常见问题.html" class="nav-link">
  Spring常见问题
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常用注解.html" class="nav-link">
  Spring常用注解
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring源码.html" class="nav-link">
  Spring源码
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring事务.html" class="nav-link">
  Spring事务
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix实战.html" class="nav-link">
  SpringCloud-Netflix实战
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix源码.html" class="nav-link">
  SpringCloud-Netflix源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/存储.html" class="nav-link">
  存储
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/计算机网络.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/操作系统.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/分布式.html" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/消息队列.html" class="nav-link">
  消息队列
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/注册中心.html" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/容器.html" class="nav-link">
  容器
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/RPC.html" class="nav-link">
  RPC
</a></li></ul></div></div><div class="nav-item"><a href="/CS-Note/算法.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/系统设计.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/信息doc安全.html" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/编码.html" class="nav-link">
  编码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目" class="mobile-dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/高性能数字货币交易系统.html" class="nav-link">
  高性能数字货币交易系统
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/手写Spring.html" class="nav-link">
  手写Spring
</a></li></ul></div></div> <a href="https://github.com/caisense/CS-Note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CS-Note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java并发.html" class="nav-link">
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java高级.html" class="nav-link">
  Java高级
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常见问题.html" class="nav-link">
  Spring常见问题
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常用注解.html" class="nav-link">
  Spring常用注解
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring源码.html" class="nav-link">
  Spring源码
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring事务.html" class="nav-link">
  Spring事务
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix实战.html" class="nav-link">
  SpringCloud-Netflix实战
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix源码.html" class="nav-link">
  SpringCloud-Netflix源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/存储.html" class="nav-link">
  存储
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/计算机网络.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/操作系统.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/分布式.html" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/消息队列.html" class="nav-link">
  消息队列
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/注册中心.html" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/容器.html" class="nav-link">
  容器
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/RPC.html" class="nav-link">
  RPC
</a></li></ul></div></div><div class="nav-item"><a href="/CS-Note/算法.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/系统设计.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/信息doc安全.html" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/编码.html" class="nav-link">
  编码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目" class="mobile-dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/高性能数字货币交易系统.html" class="nav-link">
  高性能数字货币交易系统
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/手写Spring.html" class="nav-link">
  手写Spring
</a></li></ul></div></div> <a href="https://github.com/caisense/CS-Note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#transacational原理" class="sidebar-link">@Transacational原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#事务不生效场景" class="sidebar-link">事务不生效场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_1、方法访问权限问题-非public" class="sidebar-link">1、方法访问权限问题（非public）</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_2、方法用final、static修饰" class="sidebar-link">2、方法用final、static修饰</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_3、类是final" class="sidebar-link">3、类是final</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_4、方法内部调用" class="sidebar-link">4、方法内部调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#解决" class="sidebar-link">解决</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_3-1、方法拆分" class="sidebar-link" style="padding-left:3rem;">3.1、方法拆分</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_3-2、在service类中注入自己" class="sidebar-link" style="padding-left:3rem;">3.2、在Service类中注入自己</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_3-3、通过aopcontent类" class="sidebar-link" style="padding-left:3rem;">3.3、通过AopContent类</a></li></ul></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_4、未被spring管理" class="sidebar-link">4、未被spring管理</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_5、多线程调用" class="sidebar-link">5、多线程调用</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_6、表不支持事务" class="sidebar-link">6、表不支持事务</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_7、未开启事务" class="sidebar-link">7、未开启事务</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_8、udal分片键不一致" class="sidebar-link">8、UDAL分片键不一致</a></li></ul></li><li><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#事务不回滚场景" class="sidebar-link">事务不回滚场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_1、错误的传播特性" class="sidebar-link">1、错误的传播特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#propagation参数" class="sidebar-link">propagation参数</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#嵌套事务" class="sidebar-link">嵌套事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#注意" class="sidebar-link" style="padding-left:3rem;">注意</a></li></ul></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_2、自己吞了异常" class="sidebar-link">2、自己吞了异常</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_3、手动抛了别的异常" class="sidebar-link">3、手动抛了别的异常</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_4、自定义了回滚异常" class="sidebar-link">4、自定义了回滚异常</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#_5、嵌套事务回滚多了" class="sidebar-link">5、嵌套事务回滚多了</a></li></ul></li><li><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#大事务问题" class="sidebar-link">大事务问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/CS-Note/Spring%E4%BA%8B%E5%8A%A1.html#编程式事务" class="sidebar-link">编程式事务</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Spring事务</p> <h1 id="transacational原理"><a href="#transacational原理" class="header-anchor">#</a> @Transacational原理</h1> <p>根据 @Transactional 的属性配置信息，这个代理对象（AOP Proxy）决定该声明的目标方法是否由拦截器 <code>TransactionInterceptor</code> 来使用<strong>拦截</strong>。</p> <p>拦截时，会在目标方法开始执行之前<strong>创建并加入事务</strong>，执行目标方法逻辑，最后根据执行情况是否出现异常，利用抽象事务管理器 <code>AbstractPlatformTransactionManager</code> 操作数据源 <code>DataSource</code> 来提交或回滚事务</p> <p>参数：</p> <ul><li>propagation：传播类型，枚举值见<a href="####propagation%E5%8F%82%E6%95%B0">propagation参数</a>。默认为<strong>REQUIRED</strong>。</li> <li>rollbackFor：触发回滚的异常类型，可以有多种。默认为<strong>RunTimeException</strong>。</li> <li>transactionManager：与value同名，指定事务管理器。默认为空。如果是数据库事务管理器，其实就是配置数据源。</li> <li>isolation：隔离级别（对数据库而言）。mysql 默认为 <strong>REPEATABLE_READ</strong> 可重复读</li> <li>timeout：超时时间。默认为**-1永不超时**。</li></ul> <h1 id="事务不生效场景"><a href="#事务不生效场景" class="header-anchor">#</a> 事务不生效场景</h1> <h2 id="_1、方法访问权限问题-非public"><a href="#_1、方法访问权限问题-非public" class="header-anchor">#</a> 1、方法访问权限问题（非public）</h2> <p>spring要求被代理方法必须是<code>public</code></p> <p>原因：在<code>AbstractFallbackTransactionAttributeSource</code>类的<code>computeTransactionAttribute</code>方法中有个判断，如果目标方法不是public，则返回null，即不支持事务。</p> <h2 id="_2、方法用final、static修饰"><a href="#_2、方法用final、static修饰" class="header-anchor">#</a> 2、方法用final、static修饰</h2> <p>原因：spring事务底层使用了aop，也就是通过jdk动态代理或者cglib，帮我们生成了代理类，在代理类中实现的事务功能。如果方法是final或static，则不会被拦截，代理类无法重写该方法</p> <h2 id="_3、类是final"><a href="#_3、类是final" class="header-anchor">#</a> 3、类是final</h2> <p>也是cglib的限制，final类无法生成代理</p> <h2 id="_4、方法内部调用"><a href="#_4、方法内部调用" class="header-anchor">#</a> 4、方法内部调用</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateStatus</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用事务方法失败</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doSameThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>在方法中直接调用同一个类的@Transactional方法，会导致事务失效</p> <p>原因：调用了this对象</p> <h3 id="解决"><a href="#解决" class="header-anchor">#</a> 解决</h3> <p>总之就是不让当前对象的方法a直接调方法b，可以分两个对象调用，或者让代理对象来调用</p> <h4 id="_3-1、方法拆分"><a href="#_3-1、方法拆分" class="header-anchor">#</a> 3.1、方法拆分</h4> <p>方法a和调用的方法b放在两个类中，给方法a加@Transactional</p> <h4 id="_3-2、在service类中注入自己"><a href="#_3-2、在service类中注入自己" class="header-anchor">#</a> 3.2、在Service类中注入自己</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Servcie</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceA</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Autowired</span>
   prvate <span class="token class-name">ServiceA</span> serviceA<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">queryData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">queryData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         serviceA<span class="token punctuation">.</span><span class="token function">doSave</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor<span class="token operator">=</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSave</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">addData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">updateData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这种做法会不会出现循环依赖问题？</p> <p>其实spring ioc内部的<strong>三级缓存</strong>保证了它，不会出现循环依赖问题。</p> <h4 id="_3-3、通过aopcontent类"><a href="#_3-3、通过aopcontent类" class="header-anchor">#</a> 3.3、通过AopContent类</h4> <p>在该Service类中使用AopContext.currentProxy()获取代理对象，然后由代理对象调事务方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Servcie</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceA</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">queryData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">queryData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServiceA</span><span class="token punctuation">)</span><span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doSave</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor<span class="token operator">=</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSave</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">addData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">updateData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_4、未被spring管理"><a href="#_4、未被spring管理" class="header-anchor">#</a> 4、未被spring管理</h2> <p>使用spring事务的前提是：对象要被spring管理，需要创建bean实例，即给类加@Controller、@Service、@Component、@Repository等注解</p> <h2 id="_5、多线程调用"><a href="#_5、多线程调用" class="header-anchor">#</a> 5、多线程调用</h2> <p>若两个线程获取的不是同一个数据库连接，则事务不生效</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> roleService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            roleService<span class="token punctuation">.</span><span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;保存role表数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>spring的事务是通过数据库连接来实现的。当前线程中保存了一个map，key是数据源，value是数据库连接。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Transactional resources&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同一个事务，其实是指同一个<strong>数据库连接</strong>，只有拥有同一个数据库连接才能同时提交和回滚</p> <h2 id="_6、表不支持事务"><a href="#_6、表不支持事务" class="header-anchor">#</a> 6、表不支持事务</h2> <p>原因：mysql5之前，默认的数据库引擎是<code>myisam</code>，不支持事务</p> <p>解决：在创建表的时候，只需要把<code>ENGINE</code>参数设置成<code>MyISAM</code></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>category<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>one_category<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>two_category<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>three_category<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>four_category<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>MyISAM <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_7、未开启事务"><a href="#_7、未开启事务" class="header-anchor">#</a> 7、未开启事务</h2> <p>原因：springboot通过<code>DataSourceTransactionManagerAutoConfiguration</code>类，默认开启了事务。只需要配置.yml文件的<code>spring.datasource</code>相关参数即可</p> <p>解决：传统的spring项目，则需要在applicationContext.xml手动配置</p> <h2 id="_8、udal分片键不一致"><a href="#_8、udal分片键不一致" class="header-anchor">#</a> 8、UDAL分片键不一致</h2> <p>分库的系统中，fence_subscribe_record表分片键是prod_inst_id，elec_fence表分片键是elec_fence_id，两个表分片键不一致，则要做成事务的两条数据不一定在同一片中（下面报错，一条在corp_1分片，另一条在corp_2），无法构成事务。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[PUB-1201]UDAL - Handler process error: Distributed transaction occurred, statement : /*89a86853fed14f1ebcced2c1f1ef57ae ElecFenceController.disableFenceForWeb*/  update fence_subscribe_record set  update_date = '2022-04-06 10:37:21'  ,status = 0 ,subscribe_type = 1 where prod_inst_id = 980016408905 and shard = 980016408905 is executed on cmp_corp_2 while the last statement : /*89a86853fed14f1ebcced2c1f1ef57ae ElecFenceController.disableFenceForWeb*/  update elec_fence set status_cd='1100', status_date='2022-04-06 14:49:55', update_date='2022-04-06 14:49:55'  where elec_fence_id=100000000007000 and shard=100000000007000 was executed on cmp_corp_1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h1 id="事务不回滚场景"><a href="#事务不回滚场景" class="header-anchor">#</a> 事务不回滚场景</h1> <h2 id="_1、错误的传播特性"><a href="#_1、错误的传播特性" class="header-anchor">#</a> 1、错误的传播特性</h2> <h3 id="propagation参数"><a href="#propagation参数" class="header-anchor">#</a> propagation参数</h3> <p>使用<code>@Transactional</code>注解时，可以显式指定<code>propagation</code>参数，该参数的作用是指定事务的传播特性，spring目前支持7种传播特性：</p> <ol><li><code>REQUIRED</code> **（默认值）**如果当前上下文中存在事务，那么加入该事务。如果不存在事务，创建一个事务。</li> <li><code>REQUIRES_NEW</code> 每次都会<strong>新建</strong>一个事务，并将<strong>当前上下文</strong>中的事务<strong>挂起</strong>。直到完成新事务后，再恢复执行上下文事务。</li> <li><code>SUPPORTS</code> 如果当前上下文存在事务，则支持事务加入事务，如果不存在事务，则使用非事务的方式执行。</li> <li><code>NOT_SUPPORTED</code> 如果当前上下文中存在事务，则挂起当前事务，然后新的方法在没有事务的环境中执行。</li> <li><code>MANDATORY</code> 如果当前上下文中存在事务，否则抛出异常。</li> <li><code>NEVER</code> 如果当前上下文中存在事务，则抛出异常，否则在无事务环境上执行代码。</li> <li><code>NESTED</code> 如果当前上下文中存在事务，则嵌套创建子事务。如果不存在事务，则新建事务。</li></ol> <p>只有这三种会创建新事务：REQUIRED（默认），REQUIRES_NEW，NESTED。</p> <p>如果传播特性设置错了，例如</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">NEVER</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">saveData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这种类型的传播特性不支持事务，如果有事务则会抛异常。</p> <h3 id="嵌套事务"><a href="#嵌套事务" class="header-anchor">#</a> 嵌套事务</h3> <blockquote><p>注意：嵌套事务的 <strong>回滚</strong> 不会互相影响，只要函数内有异常就回滚。</p> <p>只在 <strong>提交</strong> 时会互相影响。</p></blockquote> <p>a函数带事务，调用b函数，当b的事务传播为：</p> <ol><li>REQUIRES_NEW：新建一个事务，b的事务提交与a的事务提交独立，各自执行完就<strong>立即提交</strong>。</li> <li>NESTED：创建一个子事务，b执行完并不会立即提交，而是等待父事务（即a执行完）<strong>一起提交</strong>。</li></ol> <h2 id="_2、自己吞了异常"><a href="#_2、自己吞了异常" class="header-anchor">#</a> 2、自己吞了异常</h2> <p>最常见的问题是：开发者在代码中手动try...catch了异常，然后不继续抛出。而事务回滚是通过异常触发的</p> <h2 id="_3、手动抛了别的异常"><a href="#_3、手动抛了别的异常" class="header-anchor">#</a> 3、手动抛了别的异常</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
             <span class="token function">saveData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">updateData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>spring事务，默认情况下只会回滚<code>RuntimeException</code>（运行时异常）和<code>Error</code>（错误），对于普通的Exception（非运行时异常），它不会回滚。</p> <h2 id="_4、自定义了回滚异常"><a href="#_4、自定义了回滚异常" class="header-anchor">#</a> 4、自定义了回滚异常</h2> <p>可以通过设置<code>rollbackFor</code>参数，填入一个类型来自定义回滚的异常。</p> <p>但如果这个参数的值设置错了，例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">BusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       <span class="token function">saveData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">updateData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>执行时报错，抛了SqlException、DuplicateKeyException等异常。</p> <p>而BusinessException是我们自定义的异常，报错的异常不属于BusinessException，所以事务也不会回滚。</p> <h4 id="注意"><a href="#注意" class="header-anchor">#</a> 注意</h4> <p>即使rollbackFor有默认值，但阿里巴巴开发者规范中，还是要求开发者显式指定，建议<code>Exception</code>或<code>Throwable</code>。</p> <p>如果使用默认值RuntimeException，一旦程序抛出了Exception，事务不会回滚，</p> <h2 id="_5、嵌套事务回滚多了"><a href="#_5、嵌套事务回滚多了" class="header-anchor">#</a> 5、嵌套事务回滚多了</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> roleService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        roleService<span class="token punctuation">.</span><span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">NESTED</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;保存role表数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这种情况使用了嵌套的内部事务，原本是希望调用roleService.doOtherThing方法时，如果出现了异常，只回滚doOtherThing方法里的内容，不回滚 userMapper.insertUser里的内容，即回滚保存点。。但事实是，insertUser也回滚了。</p> <p>因为doOtherThing方法出现了异常，没有手动捕获，会继续往上抛，导致外部方法也回滚</p> <p>怎么样才能只回滚保存点呢？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 保存点</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        roleService<span class="token punctuation">.</span><span class="token function">doOtherThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以将内部嵌套事务放在try/catch中，并且不继续往上抛异常。这样就能保证，如果内部嵌套事务中出现异常，只回滚内部事务，而不影响外部事务。</p> <h1 id="大事务问题"><a href="#大事务问题" class="header-anchor">#</a> 大事务问题</h1> <p><code>@Transactional</code>注解，如果被加到方法上，有个缺点就是整个方法都包含在事务当中了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Autowired</span> 
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> roleService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       <span class="token function">query1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">query2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">query3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       roleService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">update</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Autowired</span> 
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> roleService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">UserModel</span> userModel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       <span class="token function">query4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">query5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">query6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">saveData</span><span class="token punctuation">(</span>userModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>在UserService类中，其实只有这两行才需要事务：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>roleService.save(userModel);
update(userModel);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在RoleService类中，只有这一行需要事务：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>saveData(userModel);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果query方法非常多，调用层级很深，而且有部分查询方法比较耗时的话，会造成整个事务非常耗时，而从造成大事务问题。</p> <h1 id="编程式事务"><a href="#编程式事务" class="header-anchor">#</a> 编程式事务</h1> <p>spring还提供了另外一种创建事务的方式，即通过手动编写代码实现的事务</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">TransactionTemplate</span> transactionTemplate<span class="token punctuation">;</span>
   
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">queryData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">queryData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         transactionTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">addData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在spring中为了支持编程式事务，专门提供了一个类：TransactionTemplate，在它的execute方法中，就实现了事务的功能。</p> <p>相较于<code>@Transactional</code>注解声明式事务，更建议使用基于<code>TransactionTemplate</code>的编程式事务。主要原因如下：</p> <ol><li>避免由于spring aop问题，导致事务失效的问题。</li> <li>能够<strong>更小粒度</strong>的控制事务的范围，更直观。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/6/2023, 9:36:50 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/CS-Note/assets/js/app.499d959b.js" defer></script><script src="/CS-Note/assets/js/2.3a0ab2ea.js" defer></script><script src="/CS-Note/assets/js/1.2a19e319.js" defer></script><script src="/CS-Note/assets/js/34.09c983b1.js" defer></script>
  </body>
</html>
