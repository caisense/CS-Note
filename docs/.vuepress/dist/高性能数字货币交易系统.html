<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>0.架构设计 | 个人主页</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="CZT的博客">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.c780e1b6.js" as="script"><link rel="preload" href="/assets/js/2.f44a4f26.js" as="script"><link rel="preload" href="/assets/js/30.7ca7bc7e.js" as="script"><link rel="prefetch" href="/assets/js/10.207c4431.js"><link rel="prefetch" href="/assets/js/11.747359fa.js"><link rel="prefetch" href="/assets/js/12.6c286f4f.js"><link rel="prefetch" href="/assets/js/13.c0822fad.js"><link rel="prefetch" href="/assets/js/14.75e13154.js"><link rel="prefetch" href="/assets/js/15.cf4291c4.js"><link rel="prefetch" href="/assets/js/16.babfb68b.js"><link rel="prefetch" href="/assets/js/17.600473bc.js"><link rel="prefetch" href="/assets/js/18.0b6e0252.js"><link rel="prefetch" href="/assets/js/19.cfc57187.js"><link rel="prefetch" href="/assets/js/20.dec901f2.js"><link rel="prefetch" href="/assets/js/21.bfa49832.js"><link rel="prefetch" href="/assets/js/22.a31f4be5.js"><link rel="prefetch" href="/assets/js/23.7019856d.js"><link rel="prefetch" href="/assets/js/24.45adeb21.js"><link rel="prefetch" href="/assets/js/25.43428e77.js"><link rel="prefetch" href="/assets/js/26.f37e9ddb.js"><link rel="prefetch" href="/assets/js/27.241fb6ed.js"><link rel="prefetch" href="/assets/js/28.1bf839c4.js"><link rel="prefetch" href="/assets/js/29.bbb07d62.js"><link rel="prefetch" href="/assets/js/3.1aa3be4a.js"><link rel="prefetch" href="/assets/js/4.7ac2b204.js"><link rel="prefetch" href="/assets/js/5.f702624b.js"><link rel="prefetch" href="/assets/js/6.c76c0e1e.js"><link rel="prefetch" href="/assets/js/7.414750dc.js"><link rel="prefetch" href="/assets/js/8.bc490d6c.js"><link rel="prefetch" href="/assets/js/9.0cb2026c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/Java高级.html" class="nav-link">
  Java高级
</a></li><li class="dropdown-item"><!----> <a href="/Java并发.html" class="nav-link">
  Java并发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/存储.html" class="nav-link">
  存储
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/Java高级.html" class="nav-link">
  Java高级
</a></li><li class="dropdown-item"><!----> <a href="/Java并发.html" class="nav-link">
  Java并发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/存储.html" class="nav-link">
  存储
</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_0-架构设计"><a href="#_0-架构设计" class="header-anchor">#</a> 0.架构设计</h1> <div class="language-ascii line-numbers-mode"><pre class="language-text"><code>           1  ┌───────────┐  2  ┌───────────┐  7  ┌───────────┐
Request  ────&gt;│   User    │────&gt;│  Account  │&lt;────│ Clearing  │
              └───────────┘     └───────────┘     └───────────┘
                                     3│                 ▲
                                      ▼                 │
                                ┌───────────┐           │
                                │   Order   │          6│
                                └───────────┘           │
                                     4│                 │
                                      ▼                 │
                                ┌───────────┐  5  ┌───────────┐
                                │ Sequence  │────&gt;│   Match   │
                                └───────────┘     └───────────┘
                                                        │
                                                        ▼
                                                  ┌───────────┐
Market   &lt;────────────────────────────────────────│ Quotation │
                                                  └───────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>当一个请求进入交易系统后，首先由用户系统（User）识别用户身份，然后由账户系统（Account）对用户资产进行冻结，买入冻结USD，卖出冻结BTC，冻结如果成功，订单就进入定序系统（Sequence）。</p> <p>经过定序的订单被送入撮合引擎（Match）。</p> <p>当撮合引擎输出了成交结果后，该成交记录由清算系统（Clearing）进行清算。清算的工作就是把买单冻结的USD扣掉，并加上买入所得的BTC，同时，把卖单冻结的BTC扣掉，并加上卖出所得的USD。根据taker／maker的费率，向买卖双方收取手续费。</p> <p>清算系统完成清算后，更新订单状态，再通知用户，用户就可以查询到买卖的成交情况。</p> <p>在撮合引擎输出成交记录给清算系统的同时，它还把去除用户和订单相关信息的成交记录输出给行情系统（Quotation），由行情系统保存市场的成交价、成交量等信息，并输出实时价格、K线图等技术数据，以便公开市场查询。</p> <h2 id="基于数据库"><a href="#基于数据库" class="header-anchor">#</a> 基于数据库</h2> <p>订单全部存入数据库，并且，每次撮合都基于数据库的订单进行排序，这种完全基于数据库操作，并通过数据库事务保证数据一致性的交易系统，显然性能有限，并且，对数据库的硬件配置有非常高的要求。实际上，这种交易系统的处理能力每秒在100左右，提升系统性能完全依靠数据库服务器的硬件升级</p> <h2 id="基于内存撮合"><a href="#基于内存撮合" class="header-anchor">#</a> 基于内存撮合</h2> <p>使用内存撮合的订单处理速度每秒可高达100万，但清算仍然是基于数据库事务，是整个系统的瓶颈，因此，系统的订单处理能力大约能提升到每秒1000单</p> <h2 id="基于内存撮合清算"><a href="#基于内存撮合清算" class="header-anchor">#</a> 基于内存撮合清算</h2> <p>全内存模型和前面两种设计模型有个很大的区别，就是并不需要多线程并发处理，而是依赖<strong>单线程无锁模型</strong>，让所有计算全部在内存中完成，反而可以轻松获得10万+的量级。</p> <p>好处是极高的处理速度，此外另一个好处是硬件成本很低，原因是内存非常便宜，单机32G内存就可以轻松实现每秒10万的订单处理速度。注意这里的每秒10万订单是指用户下单到订单撮合、清算全部完毕的整个流程，而不是单独指某个模块的处理速度。</p> <p>缺点是由于内存的易失性，因为不再通过数据库事务保证数据一致性，如果遭遇宕机、断电等系统故障，交易系统必须能可靠地恢复整个系统的状态</p> <h1 id="_1-定序系统"><a href="#_1-定序系统" class="header-anchor">#</a> 1.定序系统</h1> <p>为什么需要设计一个定序系统？因为交易系统的所有订单是一个有序队列。不同的用户在同一时刻下单，也必须由定序系统确定先后顺序。</p> <p>首先定义要接收的事件消息，它包含一个Sequence ID、上一个Sequence ID以及一个可选的用于去重的全局唯一ID：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbstractEvent</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessage</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定序后的Sequence ID:</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> sequenceId<span class="token punctuation">;</span>
    <span class="token comment">// 定序后的Previous Sequence ID:</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> previousId<span class="token punctuation">;</span>
    <span class="token comment">// 可选的全局唯一标识:</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> uniqueId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>定序系统接收的事件仅包含可选的<code>uniqueId</code>，忽略<code>sequenceId</code>和<code>previousId</code>。定序完成后，把<code>sequenceId</code>和<code>previousId</code>设置好，再发送给下游。</p> <p><code>SequenceService</code>用于接收上游消息、定序、发送消息给下游：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SequenceService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">SequenceHandler</span> sequenceHandler<span class="token punctuation">;</span>
    <span class="token comment">// 全局唯一递增ID:</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> sequence<span class="token punctuation">;</span>
    <span class="token comment">// 接收消息并定序再发送:</span>
    <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">processMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定序后的事件消息:</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> sequenced <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 定序:</span>
            sequenced <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceHandler<span class="token punctuation">.</span><span class="token function">sequenceMessages</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageTypes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequence<span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 定序出错时进程退出:</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;exception when do sequence&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 发送定序后的消息:</span>
        <span class="token function">sendMessages</span><span class="token punctuation">(</span>sequenced<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>SequenceHandler</code>是真正写入Sequence ID并落库的，在<code>SequenceService</code>中调用<code>SequenceHandler</code>是因为我们写入数据库时需要利用Spring提供的声明式数据库事务，而消息的接收和发送并不需要被包含在数据库事务中。</p> <h2 id="q-如何在定序器重启后正确初始化下一个序列号"><a href="#q-如何在定序器重启后正确初始化下一个序列号" class="header-anchor">#</a> Q：如何在定序器重启后正确初始化下一个序列号？</h2> <p>正确初始化下一个序列号实际上就是要把一个正确的初始值给<code>AtomicLong sequence</code>字段。可以读取数据库获得当前最大的Sequence ID，这个Sequence ID就是上次最后一次定序的ID。</p> <h2 id="q-如何在定序器崩溃后自动恢复"><a href="#q-如何在定序器崩溃后自动恢复" class="header-anchor">#</a> Q：如何在定序器崩溃后自动恢复？</h2> <p>由于任何一个时候都只能有一个定序器工作，这样才能保证Sequence ID的正确性，因此，无法让两个定序器同时工作。</p> <p>虽然无法让两个定序器同时工作，但可以让两个定序器以主备模式同时运行，仅主定序器工作。当主定序器崩溃后，备用定序器自动切换为主定序器接管后续工作即可。</p> <p>为了实现主备模式，可以启动两个定序器，然后抢锁的形式确定主备。抢到锁的定序器开始工作，并定期刷新锁，未抢到锁的定序器定期检查锁。可以用数据库锁实现主备模式。</p> <h2 id="q-如何解决定序的性能瓶颈"><a href="#q-如何解决定序的性能瓶颈" class="header-anchor">#</a> Q：如何解决定序的性能瓶颈？</h2> <p>通常来说，消息系统的吞吐量远超数据库。定序的性能取决于批量写入数据库的能力。首先要<strong>提高数据库的性能</strong>，其次考虑按Sequence ID进行分库，但分库会提高定序的复杂度，也会使下游从数据库读取消息时复杂度增加。最后，可以考虑使用专门针对时序优化的数据库，但这样就不如MySQL这种数据库通用、易用。</p> <h1 id="_2-交易引擎"><a href="#_2-交易引擎" class="header-anchor">#</a> 2.交易引擎</h1> <h2 id="_1-1-资产系统"><a href="#_1-1-资产系统" class="header-anchor">#</a> 1.1.资产系统</h2> <p><strong>用户资产</strong>：用户以各种方式将USD、BTC充入交易所后的余额</p> <p>用户在买入BTC时，需要花费USD，而卖出BTC后，获得USD。当用户下单买入时，系统会先冻结对应的USD金额；当用户下单卖出时，系统会先冻结对应的BTC。</p> <blockquote><p>之所以需要有<strong>冻结</strong>这一操作，是因为判断能否下单成功，是根据用户的可用资产判断。每下一个新的订单，就会有一部分可用资产被冻结，因此，用户资产本质上是一个由用户ID和资产ID标识的二维表。</p></blockquote> <p>使用双层map表示资产： <code>用户ID -&gt; (资产ID -&gt; Asset)</code></p> <p>在<code>AssetService</code>上定义对用户资产的操作。实际上，所有资产操作只有一种操作，即转账。转账类型可用<code>Transfer</code>定义为枚举类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Transfer</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可用转可用:</span>
    <span class="token constant">AVAILABLE_TO_AVAILABLE</span><span class="token punctuation">,</span>
    <span class="token comment">// 可用转冻结:</span>
    <span class="token constant">AVAILABLE_TO_FROZEN</span><span class="token punctuation">,</span>
    <span class="token comment">// 冻结转可用:</span>
    <span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>转账操作只需要一个<code>tryTransfer()</code>方法，实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryTransfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span> type<span class="token punctuation">,</span> <span class="token class-name">Long</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">Long</span> toUser<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span> assetId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkBalance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 转账金额不能为负:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Negative amount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取源用户资产:</span>
    <span class="token class-name">Asset</span> fromAsset <span class="token operator">=</span> <span class="token function">getAsset</span><span class="token punctuation">(</span>fromUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fromAsset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 资产不存在时初始化用户资产:</span>
        fromAsset <span class="token operator">=</span> <span class="token function">initAssets</span><span class="token punctuation">(</span>fromUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取目标用户资产:</span>
    <span class="token class-name">Asset</span> toAsset <span class="token operator">=</span> <span class="token function">getAsset</span><span class="token punctuation">(</span>toUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toAsset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 资产不存在时初始化用户资产:</span>
        toAsset <span class="token operator">=</span> <span class="token function">initAssets</span><span class="token punctuation">(</span>toUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">AVAILABLE_TO_AVAILABLE</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 需要检查余额且余额不足:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBalance <span class="token operator">&amp;&amp;</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 转账失败:</span>
                <span class="token keyword">yield</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 源用户的可用资产减少:</span>
            fromAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 目标用户的可用资产增加:</span>
            toAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> toAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回成功:</span>
            <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            <span class="token comment">// 从可用转至冻结:</span>
        <span class="token keyword">case</span> <span class="token constant">AVAILABLE_TO_FROZEN</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBalance <span class="token operator">&amp;&amp;</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            fromAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            toAsset<span class="token punctuation">.</span>frozen <span class="token operator">=</span> toAsset<span class="token punctuation">.</span>frozen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            <span class="token comment">// 从冻结转至可用:</span>
        <span class="token keyword">case</span> <span class="token constant">FROZEN_TO_AVAILABLE</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBalance <span class="token operator">&amp;&amp;</span> fromAsset<span class="token punctuation">.</span>frozen<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            fromAsset<span class="token punctuation">.</span>frozen <span class="token operator">=</span> fromAsset<span class="token punctuation">.</span>frozen<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            toAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> toAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid type: &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>除了用户存入资产时，需要调用<code>tryTransfer()</code>并且不检查余额，因为此操作是从系统负债账户向用户转账，其他常规转账操作均需要检查余额：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span> type<span class="token punctuation">,</span> <span class="token class-name">Long</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">Long</span> toUser<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span> assetId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryTransfer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> fromUser<span class="token punctuation">,</span> toUser<span class="token punctuation">,</span> assetId<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Transfer failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>冻结和解冻操作，其实都是在<code>tryTransfer()</code>基础上封装。</p> <p>测试验证：交易所要保证任意操作后，所有用户资产的各余额总和为0（有一个特殊账户--系统账户，用户充值实际上是系统账户对用户账户转账，整个系统无外部金额输入，总和应为0）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AssetServiceTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">tryTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="q-为什么不使用数据库"><a href="#q-为什么不使用数据库" class="header-anchor">#</a> Q：为什么不使用数据库？</h3> <p>因为我们要实现的交易引擎是100%全内存交易引擎，因此所有用户资产均存放在内存中，无需访问数据库。</p> <h3 id="q-为什么要使用concurrentmap"><a href="#q-为什么要使用concurrentmap" class="header-anchor">#</a> Q：为什么要使用ConcurrentMap？</h3> <p><strong>并不是为了让多线程并发写入，而是为了多线程读</strong></p> <p>使用<code>ConcurrentMap</code>并不是为了让多线程并发写入，因为<code>AssetService</code>中并没有任何同步锁。对<code>AssetService</code>进行写操作必须是单线程，不支持多线程调用<code>tryTransfer()</code>。</p> <p>但是读取Asset支持多线程并发读取，这也是使用<code>ConcurrentMap</code>的原因。如果改成<code>HashMap</code>，根据不同JDK版本的实现不同，多线程读取<code>HashMap</code>可能造成死循环（注意这不是<code>HashMap</code>的bug），必须引入同步机制。</p> <h3 id="q-如何扩展以支持更多的资产类型"><a href="#q-如何扩展以支持更多的资产类型" class="header-anchor">#</a> Q：如何扩展以支持更多的资产类型？</h3> <p>我们在<code>AssetEnum</code>中以枚举方式定义了USD和BTC两种资产，如果要扩展到更多资产类型，可以以整型ID作为资产ID，同时需要管理一个资产ID到资产名称的映射，这样可以在业务需要的时候更改资产名称。</p> <h2 id="_1-2-订单系统"><a href="#_1-2-订单系统" class="header-anchor">#</a> 1.2.订单系统</h2> <p>一个订单由订单ID唯一标识。为简化设计，该对象既作为订单系统的订单对象，也作为数据库映射实体。包含以下重要字段：</p> <ul><li>userId：订单关联的用户ID；</li> <li>sequenceId：定序ID，相同价格的订单根据定序ID进行排序；</li> <li>direction：订单方向：买或卖；</li> <li>price：订单价格；</li> <li>quantity：订单数量；</li> <li>unfilledQuantity：尚未成交的数量；</li> <li>status：订单状态，包括等待成交、部分成交、完全成交、部分取消、完全取消。</li></ul> <p>创建订单：先<strong>冻结</strong>要交易的资产（买入冻结USD，卖出冻结BTC），再创建。一个订单被成功创建后，它后续由撮合引擎处理时，只有<code>unfilledQuantity</code>和<code>status</code>会发生变化，其他属性均为只读，不会改变。</p> <p>删除订单：当订单状态变为完全成交、部分取消、完全取消时，订单就已经处理完成。处理完成的订单从订单系统中删除，并写入数据库永久变为历史订单。用户查询活动订单时，需要读取订单系统，用户查询历史订单时，只需从数据库查询，就与订单系统无关了。</p> <p>根据业务需要，订单系统需要支持：</p> <ul><li>根据订单ID查询到订单；</li> <li>根据用户ID查询到该用户的所有活动订单。</li></ul> <p>因此，<code>OrderService</code>需要用两个<code>Map</code>存储活动订单：</p> <p>activeOrders：跟踪所有活动订单<code>map&lt;OrderID, OrderEntity&gt;</code></p> <p>userOrders：二维map，跟踪用户活动订单<code>map&lt;UserID, Map&lt;OrderID, OrderEntity&gt;&gt;</code></p> <p>添加和删除Order，要更新这两个map。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 创建订单，失败返回null:
 */</span>
<span class="token keyword">public</span> <span class="token class-name">OrderEntity</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token keyword">long</span> ts<span class="token punctuation">,</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Direction</span> direction<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> quantity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 买入，需冻结USD：</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>assetService<span class="token punctuation">.</span><span class="token function">tryFreeze</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 卖出，需冻结BTC：</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>assetService<span class="token punctuation">.</span><span class="token function">tryFreeze</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">BTC</span><span class="token punctuation">,</span> quantity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid direction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 实例化Order:</span>
    <span class="token class-name">OrderEntity</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>id <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>sequenceId <span class="token operator">=</span> sequenceId<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>direction <span class="token operator">=</span> direction<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>quantity <span class="token operator">=</span> quantity<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>unfilledQuantity <span class="token operator">=</span> quantity<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> order<span class="token punctuation">.</span>updatedAt <span class="token operator">=</span> ts<span class="token punctuation">;</span>
    <span class="token comment">// 添加到ActiveOrders:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>activeOrders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加到UserOrders:</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> uOrders <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userOrders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uOrders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userOrders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> uOrders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    uOrders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="q-order的id和sequenceid为何不合并使用一个id"><a href="#q-order的id和sequenceid为何不合并使用一个id" class="header-anchor">#</a> Q：Order的id和sequenceId为何不合并使用一个ID？</h3> <p>订单ID是Order.id，是用户看到的订单标识，而Order.sequenceId是系统内部给订单的定序序列号，用于后续撮合时进入订单簿的排序，两者功能不同。</p> <p>可以使用一个简单的算法来根据Sequence ID计算Order ID：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>OrderID = SequenceID * 10000 + today(&quot;YYmm&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为SequenceID是全局唯一的，我们给SequenceID添加创建日期的&quot;YYmm&quot;部分，可轻松实现按月分库保存和查询。</p> <h2 id="_1-3-撮合引擎"><a href="#_1-3-撮合引擎" class="header-anchor">#</a> 1.3 撮合引擎</h2> <p>撮合引擎是交易系统的核心。本质上就是维护一个<strong>买卖盘</strong>列表，然后按价格优先原则对订单进行撮合，能够成交的就输出成交结果，不能成交的放入买卖盘。这里注意没有时间优先原则，因为经过定序的订单队列已经是一个时间优先的队列了。</p> <h3 id="订单薄orderbook"><a href="#订单薄orderbook" class="header-anchor">#</a> 订单薄OrderBook</h3> <p>用来表示买卖盘</p> <p>买盘排序：价格高在前，价格相同时间早在前</p> <p>卖盘排序：价格低在前，价格相同时间早在前</p> <p>首先考虑list，但插入删除效率低，因此用红黑树（TreeMap实现），以<strong>定序id</strong>比较时间</p> <blockquote><p>订单上虽然保存了创建时间，但排序时，是根据定序ID即<code>sequenceId</code>来排序，以确保全局唯一。时间本身实际上是订单的一个普通属性，仅展示给用户，不参与业务排序。</p></blockquote> <h3 id="撮合引擎matchengine"><a href="#撮合引擎matchengine" class="header-anchor">#</a> 撮合引擎MatchEngine</h3> <p>定义<code>MatchEngine</code>核心数据结构如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatchEngine</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">OrderBook</span> buyBook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderBook</span><span class="token punctuation">(</span><span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">BUY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 买盘</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">OrderBook</span> sellBook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderBook</span><span class="token punctuation">(</span><span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">SELL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 卖盘</span>
    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> marketPrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span> <span class="token comment">// 最新市场价</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> sequenceId<span class="token punctuation">;</span> <span class="token comment">// 上次处理的Sequence ID</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>一个完整的撮合引擎包含一个买盘、一个卖盘和一个最新成交价（初始值为0）。撮合引擎的输入是一个<code>OrderEntity</code>实例，每处理一个订单，就输出撮合结果<code>MatchResult</code>。</p> <p>对于撮合交易来说，如果新订单是一个买单，则首先尝试在卖盘中匹配价格合适的卖单，如果匹配成功则成交。</p> <blockquote><p>一个大的买单可能会匹配多个较小的卖单。当买单被完全匹配后，说明此买单已完全成交，处理结束，否则，如果存在未成交的买单，则将其放入买盘。处理卖单的逻辑是类似的。</p></blockquote> <p>已经挂在买卖盘的订单称为挂单（Maker），当前正在处理的订单称为吃单（Taker），一个Taker订单如果<strong>未完全成交</strong>则转为Maker挂在买卖盘。</p> <p>核心处理方法定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">MatchResult</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 买单与sellBook匹配，（如果还有剩）最后放入buyBook:</span>
        <span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token function">processOrder</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sellBook<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buyBook<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 卖单与buyBook匹配，（如果还有剩）最后放入sellBook:</span>
        <span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token function">processOrder</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buyBook<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sellBook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid direction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">MatchResult</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> takerOrder<span class="token punctuation">,</span> <span class="token class-name">OrderBook</span> makerBook<span class="token punctuation">,</span> <span class="token class-name">OrderBook</span> anotherBook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>撮合结果记录在<code>MatchResult</code>中，它可以用一个Taker订单和一系列撮合匹配记录表示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatchResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Order</span> takerOrder<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatchDetailRecord</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">MatchDetails</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造方法略</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>每一笔撮合记录则由成交双方、成交价格与数量表示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">MatchDetailRecord</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span> price<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> quantity<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> takerOrder<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> makerOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>根据价格匹配，直到成交双方有一方完全成交或成交条件不满足时结束处理，<code>processOrder()</code>的业务逻辑代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @param sequenceId 定序id
     * @param takerOrder  当前正在处理的订单
     * @param makerBook   尝试匹配成交的OrderBook（对手盘）
     * @param anotherBook 未能完全成交后挂单的OrderBook
     * @return 成交结果
     */</span>
<span class="token keyword">private</span> <span class="token class-name">MatchResult</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> takerOrder<span class="token punctuation">,</span> <span class="token class-name">OrderBook</span> makerBook<span class="token punctuation">,</span>
                                 <span class="token class-name">OrderBook</span> anotherBook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceId <span class="token operator">=</span> sequenceId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> ts <span class="token operator">=</span> takerOrder<span class="token punctuation">.</span>createdAt<span class="token punctuation">;</span>
    <span class="token class-name">MatchResult</span> matchResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResult</span><span class="token punctuation">(</span>takerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> takerUnfilledQuantity <span class="token operator">=</span> takerOrder<span class="token punctuation">.</span>quantity<span class="token punctuation">;</span>
    <span class="token comment">// 一直循环，每次取maker（对手盘）第一个，目标是将taker完全匹配完</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> makerOrder <span class="token operator">=</span> makerBook<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>makerOrder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对手盘不存在:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>takerOrder<span class="token punctuation">.</span>direction <span class="token operator">==</span> <span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">BUY</span> <span class="token operator">&amp;&amp;</span> takerOrder<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 买入订单价格比卖盘第一档价格低:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>takerOrder<span class="token punctuation">.</span>direction <span class="token operator">==</span> <span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">SELL</span> <span class="token operator">&amp;&amp;</span> takerOrder<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 卖出订单价格比买盘第一档价格高:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 以Maker价格成交:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>marketPrice <span class="token operator">=</span> makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
        <span class="token comment">// 待成交数量为两者较小值:</span>
        <span class="token class-name">BigDecimal</span> matchedQuantity <span class="token operator">=</span> takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 成交记录:（价格、数量、maker</span>
        matchResult<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">,</span> matchedQuantity<span class="token punctuation">,</span> makerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新成交后的订单数量:</span>
        <span class="token comment">// taker数量减去待成交数量</span>
        takerUnfilledQuantity <span class="token operator">=</span> takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>matchedQuantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> makerUnfilledQuantity <span class="token operator">=</span> makerOrder<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>matchedQuantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对手盘完全成交后，从订单簿中删除:</span>
        <span class="token comment">// 即看成交后的订单数是否为0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>makerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            makerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>makerUnfilledQuantity<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">FULLY_FILLED</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            makerBook<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对手盘部分成交:</span>
            makerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>makerUnfilledQuantity<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">PARTIAL_FILLED</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Taker订单完全成交后，退出循环:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            takerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">FULLY_FILLED</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment">// end for</span>
    <span class="token comment">// Taker订单未完全成交时，放入买/卖订单簿:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        takerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">,</span>
                               takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>takerOrder<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>
                               <span class="token operator">:</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">PARTIAL_FILLED</span><span class="token punctuation">,</span>
                               ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        anotherBook<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>takerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> matchResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h2 id="_1-4-清算系统"><a href="#_1-4-清算系统" class="header-anchor">#</a> 1.4 清算系统</h2> <p>要把撮合结果最终实现为买卖双方的资产交换，就需要清算。清算系统就是处理撮合结果，将买卖双方冻结的USD和BTC分别交换到对方的可用余额，就使得买卖双方真正完成了资产交换。</p> <p>设计清算系统<code>ClearingService</code>，需要引用<code>AssetService</code>和<code>OrderService</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClearingService</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AssetService</span> assetService<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ClearingService</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">AssetService</span> assetService<span class="token punctuation">,</span> <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>assetService <span class="token operator">=</span> assetService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderService <span class="token operator">=</span> orderService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>撮合引擎输出<code>MatchResult</code>后，<code>ClearingService</code>需要处理该结果，，该清算方法代码框架如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearMatchResult</span><span class="token punctuation">(</span><span class="token class-name">MatchResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> taker <span class="token operator">=</span> result<span class="token punctuation">.</span>takerOrder<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid direction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="买入"><a href="#买入" class="header-anchor">#</a> 买入</h3> <p>买家冻结的USD转入卖方账户，卖方冻结的BTC转入买方账户。</p> <blockquote><p>对Taker买入成交的订单，处理时需要注意，成交价格是按照Maker的报价成交的，而Taker冻结的金额是按照Taker订单的报价冻结的，因此，解冻后，部分差额要退回至Taker可用余额</p> <p>交易资产在哪冻结的？创建订单时。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 买入时，按Maker的价格成交：</span>
<span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
     <span class="token comment">// 遍历撮合结果的所有匹配记录</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MatchDetailRecord</span> detail <span class="token operator">:</span> result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> maker <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">makerOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> matched <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">quantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 实际买入价比报价低，部分USD退回账户:</span>
            <span class="token class-name">BigDecimal</span> unfreezeQuote <span class="token operator">=</span> taker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">;</span>
            assetService<span class="token punctuation">.</span><span class="token function">unfreeze</span><span class="token punctuation">(</span>taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span> unfreezeQuote<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 买方USD转入卖方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span> maker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 卖方BTC转入买方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">BTC</span><span class="token punctuation">,</span> matched<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除完全成交的Maker:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除完全成交的Taker:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>taker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="卖出"><a href="#卖出" class="header-anchor">#</a> 卖出</h3> <p><strong>卖家出BTC，换买家的USD</strong></p> <p>对Taker卖出成交的订单，只需将冻结的BTC转入Maker，将Maker冻结的USD转入Taker即可：</p> <blockquote><p>这里不用考虑差价，因为设计下单时，卖单冻结的是BTC，换成USD直接按挂单价换算即可。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MatchDetailRecord</span> detail <span class="token operator">:</span> result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> maker <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">makerOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> matched <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">quantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 卖方BTC转入买方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">BTC</span><span class="token punctuation">,</span> matched<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 买方USD转入卖方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span> maker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除完全成交的Maker:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除完全成交的Taker:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>taker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="_1-5-完成交易引擎"><a href="#_1-5-完成交易引擎" class="header-anchor">#</a> 1.5 完成交易引擎</h2> <p>把上述模块整合，实现一个完整的交易引擎：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TradingEngineService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AssetService</span> assetService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MatchEngine</span> matchEngine<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ClearingService</span> clearingService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="整合定序系统"><a href="#整合定序系统" class="header-anchor">#</a> 整合定序系统</h3> <p>交易引擎由事件驱动，因此，通过订阅Kafka的Topic实现批量读消息，然后依次处理每个事件。由于【定序系统】的作用，消息的sequenceId应该<strong>严格递增</strong>，考虑消息重复和消息丢失两种情况：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">processMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processEvent</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重复消息，丢弃</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>sequenceId <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;skip duplicate event: {}&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    <span class="token comment">// 丢失了消息，从数据库读取恢复</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>previousId <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> events <span class="token operator">=</span> storeService<span class="token punctuation">.</span><span class="token function">loadEventsFromDb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastSequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 读取失败</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> e <span class="token operator">:</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 处理丢失的消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断当前消息是否指向上一条消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>previousId <span class="token operator">!=</span> lastSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不满足说明【系统异常】，退出</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">OrderRequestEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderRequestEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">OrderCancelEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderCancelEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">TransferEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TransferEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>这样，对消息系统的依赖就不是要求它100%可靠，遇到重复消息、丢失消息，交易引擎都可以从这些错误中自己恢复。</p> <p>目前一共有3种类型的事件：创建订单、取消订单、转账，处理都非常简单。以<code>createOrder()</code>为例，核心代码很少：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderRequestEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生成Order ID:</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> event<span class="token punctuation">.</span>sequenceId <span class="token operator">*</span> <span class="token number">10000</span> <span class="token operator">+</span> <span class="token punctuation">(</span>year <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建Order:</span>
    <span class="token class-name">OrderEntity</span> order <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>sequenceId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>createdAt<span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> event<span class="token punctuation">.</span>price<span class="token punctuation">,</span> event<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;create order failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 撮合:</span>
    <span class="token class-name">MatchResult</span> result <span class="token operator">=</span> matchEngine<span class="token punctuation">.</span><span class="token function">processOrder</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>sequenceId<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清算:</span>
    clearingService<span class="token punctuation">.</span><span class="token function">clearMatchResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="异步处理"><a href="#异步处理" class="header-anchor">#</a> 异步处理</h3> <p>核心的业务逻辑并不复杂，只是交易引擎在处理完订单后，仅仅改变自身状态是不够的，它还得向外输出具体的成交信息、订单状态等。</p> <p>因此，需要根据业务需求，在清算后继续收集撮合结果、已完成订单、准备发送的通知等，通过消息系统或Redis向外输出交易信息。</p> <p>如果把这些功能放到同一个线程内同步完成是非常耗时的，更好的方法是把它们先存储起来，再<strong>异步处理</strong>。</p> <p>例如，对于已完成的订单，可以异步落库：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> orderQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderRequestEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 清算完成后,收集已完成Order:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> closedOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>takerOrder<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isFinalStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            closedOrders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>takerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MatchDetailRecord</span> detail <span class="token operator">:</span> result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">OrderEntity</span> maker <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">makerOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maker<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isFinalStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                closedOrders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>maker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>closedOrders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 启动一个线程将orderQueue的Order异步写入数据库:</span>
<span class="token keyword">void</span> <span class="token function">saveOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO:</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>类似的，输出OrderBook、通知用户成交等信息都是异步处理。</p> <h3 id="验证模块"><a href="#验证模块" class="header-anchor">#</a> 验证模块</h3> <p>由于资产、订单、撮合、清算都在内存中完成，如何保证交易引擎每处理一个事件，它的内部状态都是正确的呢？我们可以为交易引擎增加一个自验证功能，在debug模式下，每处理一个事件，就自动验证内部状态的完整性，包括：</p> <ul><li>验证资产系统总额为0，且除负债账户外其余账户资产不为负；</li> <li>验证订单系统未成交订单所冻结的资产与资产系统中的冻结一致；</li> <li>验证订单系统的订单与撮合引擎的订单簿一对一存在。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>debugMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;start validate...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateMatchEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;validate ok.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这样我们就能快速在开发阶段尽可能早地发现问题。</p> <h3 id="q-交易引擎崩溃后如何恢复"><a href="#q-交易引擎崩溃后如何恢复" class="header-anchor">#</a> Q：交易引擎崩溃后如何恢复？</h3> <p>交易引擎如果运行时崩溃，可以重启，然后把现有的<strong>所有交易事件重头开始执行一遍</strong>，即可得到最新的状态。</p> <p>注意到重头开始执行交易事件，会导致重复发出市场成交、用户订单通知等事件，因此，可根据时间做判断，不再重复发通知。下游系统在处理通知事件时，也要根据通知携带的<code>sequenceId</code>做去重判断。</p> <h3 id="q-如果现有的交易事件太多-恢复需要花费几天-怎么办"><a href="#q-如果现有的交易事件太多-恢复需要花费几天-怎么办" class="header-anchor">#</a> Q：如果现有的交易事件太多，恢复需要花费几天，怎么办？</h3> <p>可以定期把交易引擎的<strong>状态序列化</strong>至文件系统，例如，每10分钟一次。当交易引擎崩溃时，读取最新的状态文件，即可恢复至约10分钟前的状态，后续追赶只需要执行很少的事件消息。</p> <p>交易引擎的状态包括：</p> <ul><li>资产系统的状态：即所有用户的资产列表；</li> <li>订单系统的状态：即所有活动订单列表；</li> <li>撮合引擎的状态：即买卖盘和最新市场价；</li> <li>最后一次处理的sequenceId。</li></ul> <p>序列化时，分别针对每个子系统进行序列化。对资产系统来说，每个用户的资产可序列化为<code>用户ID: [USD可用, USD冻结, BTC可用, BTC冻结]</code>的JSON格式，整个资产系统序列化后结构如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;1&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-123000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-12.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;100&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">60000</span><span class="token punctuation">,</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;200&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">43000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>订单系统可序列化为一系列活动订单列表：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">10012207</span><span class="token punctuation">,</span> <span class="token property">&quot;sequenceId&quot;</span><span class="token operator">:</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">20901</span><span class="token punctuation">,</span> ...<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">10022207</span><span class="token punctuation">,</span> <span class="token property">&quot;sequenceId&quot;</span><span class="token operator">:</span> <span class="token number">1002</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">20902</span><span class="token punctuation">,</span> ...<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>撮合引擎可序列化为买卖盘列表（仅包含订单ID）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;BUY&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10012207</span><span class="token punctuation">,</span> <span class="token number">10022207</span><span class="token punctuation">,</span> ...<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;SELL&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;marketPrice&quot;</span><span class="token operator">:</span> <span class="token number">20901</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后合并为一个交易引擎的状态文件：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;sequenceId&quot;</span><span class="token operator">:</span> <span class="token number">189000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;orders&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>交易引擎启动时，读取状态文件，然后依次恢复资产系统、订单系统和撮合引擎的状态，就得到了指定<code>sequenceId</code>的状态。</p> <p>写入状态时，如果是异步写入，需要先复制状态、再写入，防止多线程读同一实例导致状态不一致。读写JSON时，要使用JSON库的流式API（例如Jackson的Streaming API），以免内存溢出。对<code>BigDecimal</code>进行序列化时，要注意不要误读为<code>double</code>类型以免丢失精度。</p> <h1 id="_3-api系统"><a href="#_3-api系统" class="header-anchor">#</a> 3.API系统</h1> <h1 id="_4-行情系统"><a href="#_4-行情系统" class="header-anchor">#</a> 4.行情系统</h1> <h1 id="_5-推送系统"><a href="#_5-推送系统" class="header-anchor">#</a> 5.推送系统</h1></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c780e1b6.js" defer></script><script src="/assets/js/2.f44a4f26.js" defer></script><script src="/assets/js/30.7ca7bc7e.js" defer></script>
  </body>
</html>
