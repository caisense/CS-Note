<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、Bean生成过程 | 计算机面试指北</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="计算机面试指北">
    
    <link rel="preload" href="/CS-Note/assets/css/0.styles.37b6130a.css" as="style"><link rel="preload" href="/CS-Note/assets/js/app.499d959b.js" as="script"><link rel="preload" href="/CS-Note/assets/js/2.3a0ab2ea.js" as="script"><link rel="preload" href="/CS-Note/assets/js/1.2a19e319.js" as="script"><link rel="preload" href="/CS-Note/assets/js/37.e0c6270e.js" as="script"><link rel="prefetch" href="/CS-Note/assets/js/10.d51ac22e.js"><link rel="prefetch" href="/CS-Note/assets/js/11.b53fe42a.js"><link rel="prefetch" href="/CS-Note/assets/js/12.7aa00c78.js"><link rel="prefetch" href="/CS-Note/assets/js/13.67223a8e.js"><link rel="prefetch" href="/CS-Note/assets/js/14.207a62d8.js"><link rel="prefetch" href="/CS-Note/assets/js/15.13447313.js"><link rel="prefetch" href="/CS-Note/assets/js/16.5f3d6fd5.js"><link rel="prefetch" href="/CS-Note/assets/js/17.56e70d25.js"><link rel="prefetch" href="/CS-Note/assets/js/18.f14668a4.js"><link rel="prefetch" href="/CS-Note/assets/js/19.fd36e329.js"><link rel="prefetch" href="/CS-Note/assets/js/20.ac1cf63f.js"><link rel="prefetch" href="/CS-Note/assets/js/21.c82e808b.js"><link rel="prefetch" href="/CS-Note/assets/js/22.8a129fa2.js"><link rel="prefetch" href="/CS-Note/assets/js/23.4bc57570.js"><link rel="prefetch" href="/CS-Note/assets/js/24.73b21b26.js"><link rel="prefetch" href="/CS-Note/assets/js/25.b8611692.js"><link rel="prefetch" href="/CS-Note/assets/js/26.a296c369.js"><link rel="prefetch" href="/CS-Note/assets/js/27.42b29ccc.js"><link rel="prefetch" href="/CS-Note/assets/js/28.f5d9ff11.js"><link rel="prefetch" href="/CS-Note/assets/js/29.734fa758.js"><link rel="prefetch" href="/CS-Note/assets/js/3.9d4db8bf.js"><link rel="prefetch" href="/CS-Note/assets/js/30.17548d71.js"><link rel="prefetch" href="/CS-Note/assets/js/31.3dc09066.js"><link rel="prefetch" href="/CS-Note/assets/js/32.0fe7da6f.js"><link rel="prefetch" href="/CS-Note/assets/js/33.a522da37.js"><link rel="prefetch" href="/CS-Note/assets/js/34.09c983b1.js"><link rel="prefetch" href="/CS-Note/assets/js/35.e76434f5.js"><link rel="prefetch" href="/CS-Note/assets/js/36.39026a8c.js"><link rel="prefetch" href="/CS-Note/assets/js/38.a3b88467.js"><link rel="prefetch" href="/CS-Note/assets/js/39.cbbe4c99.js"><link rel="prefetch" href="/CS-Note/assets/js/4.eed64932.js"><link rel="prefetch" href="/CS-Note/assets/js/40.32d35e6a.js"><link rel="prefetch" href="/CS-Note/assets/js/41.96ec4146.js"><link rel="prefetch" href="/CS-Note/assets/js/42.1c7206ce.js"><link rel="prefetch" href="/CS-Note/assets/js/43.9cf3acc6.js"><link rel="prefetch" href="/CS-Note/assets/js/44.de1adacc.js"><link rel="prefetch" href="/CS-Note/assets/js/45.0d47c93a.js"><link rel="prefetch" href="/CS-Note/assets/js/46.6109a5cc.js"><link rel="prefetch" href="/CS-Note/assets/js/47.e3ee1a02.js"><link rel="prefetch" href="/CS-Note/assets/js/48.7c856d25.js"><link rel="prefetch" href="/CS-Note/assets/js/49.08d863fe.js"><link rel="prefetch" href="/CS-Note/assets/js/5.8ea92bac.js"><link rel="prefetch" href="/CS-Note/assets/js/50.b38b6f84.js"><link rel="prefetch" href="/CS-Note/assets/js/51.eb35dbda.js"><link rel="prefetch" href="/CS-Note/assets/js/6.7df2cbe2.js"><link rel="prefetch" href="/CS-Note/assets/js/7.e0fadba1.js"><link rel="prefetch" href="/CS-Note/assets/js/vendors~docsearch.2493936b.js">
    <link rel="stylesheet" href="/CS-Note/assets/css/0.styles.37b6130a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CS-Note/" class="home-link router-link-active"><img src="images/hero.png" alt="计算机面试指北" class="logo"> <span class="site-name can-hide">计算机面试指北</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CS-Note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java并发.html" class="nav-link">
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java高级.html" class="nav-link">
  Java高级
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常见问题.html" class="nav-link">
  Spring常见问题
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常用注解.html" class="nav-link">
  Spring常用注解
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring源码.html" class="nav-link">
  Spring源码
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring事务.html" class="nav-link">
  Spring事务
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix实战.html" class="nav-link">
  SpringCloud-Netflix实战
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix源码.html" class="nav-link">
  SpringCloud-Netflix源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/存储.html" class="nav-link">
  存储
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/计算机网络.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/操作系统.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/分布式.html" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/消息队列.html" class="nav-link">
  消息队列
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/注册中心.html" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/容器.html" class="nav-link">
  容器
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/RPC.html" class="nav-link">
  RPC
</a></li></ul></div></div><div class="nav-item"><a href="/CS-Note/算法.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/系统设计.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/信息doc安全.html" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/编码.html" class="nav-link">
  编码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目" class="mobile-dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/高性能数字货币交易系统.html" class="nav-link">
  高性能数字货币交易系统
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/手写Spring.html" class="nav-link">
  手写Spring
</a></li></ul></div></div> <a href="https://github.com/caisense/CS-Note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CS-Note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java并发.html" class="nav-link">
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java高级.html" class="nav-link">
  Java高级
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常见问题.html" class="nav-link">
  Spring常见问题
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常用注解.html" class="nav-link">
  Spring常用注解
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring源码.html" class="nav-link">
  Spring源码
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring事务.html" class="nav-link">
  Spring事务
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix实战.html" class="nav-link">
  SpringCloud-Netflix实战
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix源码.html" class="nav-link">
  SpringCloud-Netflix源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/存储.html" class="nav-link">
  存储
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/计算机网络.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/操作系统.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/分布式.html" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/消息队列.html" class="nav-link">
  消息队列
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/注册中心.html" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/容器.html" class="nav-link">
  容器
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/RPC.html" class="nav-link">
  RPC
</a></li></ul></div></div><div class="nav-item"><a href="/CS-Note/算法.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/系统设计.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/信息doc安全.html" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/编码.html" class="nav-link">
  编码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目" class="mobile-dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/高性能数字货币交易系统.html" class="nav-link">
  高性能数字货币交易系统
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/手写Spring.html" class="nav-link">
  手写Spring
</a></li></ul></div></div> <a href="https://github.com/caisense/CS-Note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>一、Bean生成过程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#一、bean生成过程" class="sidebar-link">一、Bean生成过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_1-生成beandefinition" class="sidebar-link">1.生成BeanDefinition</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_2-合并beandefinition" class="sidebar-link">2.合并BeanDefinition</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#getbean方法" class="sidebar-link">getBean方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_3-加载类" class="sidebar-link">3.加载类</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_4-实例化前" class="sidebar-link">4.实例化前</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_5-实例化" class="sidebar-link">5.实例化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_5-1-supplier创建对象" class="sidebar-link">5.1 Supplier创建对象</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_5-2-工厂方法创建对象" class="sidebar-link">5.2 工厂方法创建对象</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_5-3-推断构造方法" class="sidebar-link">5.3 推断构造方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_6-beandefinition的后置处理" class="sidebar-link">6. BeanDefinition的后置处理</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_7-实例化后" class="sidebar-link">7. 实例化后</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_8-自动注入-填充属性" class="sidebar-link">8. 自动注入（填充属性）</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_9-处理属性" class="sidebar-link">9. 处理属性</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_10-执行aware" class="sidebar-link">10. 执行Aware</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_11-初始化前" class="sidebar-link">11. 初始化前</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_12-初始化" class="sidebar-link">12. 初始化</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_13-初始化后" class="sidebar-link">13. 初始化后</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#总结beanpostprocessor" class="sidebar-link">总结BeanPostProcessor</a></li></ul></li><li><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#二、bean销毁过程" class="sidebar-link">二、Bean销毁过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#扫描过程" class="sidebar-link">扫描过程</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#spring容器关闭过程" class="sidebar-link">Spring容器关闭过程</a></li></ul></li><li><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#三、依赖注入" class="sidebar-link">三、依赖注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_1-已过期的-xml注入" class="sidebar-link">1.（已过期的）xml注入</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_2-autowired方式" class="sidebar-link">2. @Autowired方式</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_3-resource注解" class="sidebar-link">3. @Resource注解</a></li></ul></li><li><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#四、循环依赖" class="sidebar-link">四、循环依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_1-基本情形-引入earlysingletonobjects" class="sidebar-link">1.基本情形--引入earlySingletonObjects</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#_2-aop情形-引入singletonfactories" class="sidebar-link">2.AOP情形--引入singletonFactories</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#版本1" class="sidebar-link">版本1</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#版本2" class="sidebar-link">版本2</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#最终方案" class="sidebar-link">最终方案</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#源码" class="sidebar-link">源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#缓存流动顺序" class="sidebar-link">缓存流动顺序</a></li></ul></li></ul></li><li><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#五、推断构造" class="sidebar-link">五、推断构造</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#流程" class="sidebar-link">流程</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#优先级" class="sidebar-link">优先级</a></li><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#宽松模式和严格模式" class="sidebar-link">宽松模式和严格模式</a></li></ul></li><li><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#六、启动过程" class="sidebar-link">六、启动过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/Spring%E6%BA%90%E7%A0%81.html#q-spring的main方法如何执行" class="sidebar-link">Q：spring的main方法如何执行？</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一、bean生成过程"><a href="#一、bean生成过程" class="header-anchor">#</a> 一、Bean生成过程</h1> <p>流程：</p> <img src="images/Spring常见问题/image-20221201010853186.png" alt="image-20221201010853186"> <h2 id="_1-生成beandefinition"><a href="#_1-生成beandefinition" class="header-anchor">#</a> 1.生成BeanDefinition</h2> <p>扫描流程</p> <img src="images/Spring常见问题/Spring扫描底层流程.png" alt="Spring扫描底层流程"> <p>实现：org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#scanCandidateComponents</p> <ol><li><p>首先，通过ResourcePatternResolver获得指定包路径（默认是classpath）下的所有 .class 文件，保存为<strong>Resource</strong>对象。</p></li> <li><p>遍历每个Resource，解析Resource对象得到<strong>MetadataReader</strong>（具体实现类为SimpleMetadataReader）</p> <p>利用MetadataReaderFactory，实现类为CachingMetadataReaderFactory</p></li> <li><p>过滤：</p> <ol><li>利用MetadataReader进行@Component注解的<strong>excludeFilters</strong>和<strong>includeFilters</strong>判断，进行第一次过滤</li> <li>过滤后再进行条件注解**@Conditional**的筛选（条件注解并不能理解：某个类上是否存在@Conditional注解，如果存在则调用注解中所指定的类的match方法进行匹配，匹配成功则通过筛选，匹配失败则pass掉。）</li></ol></li> <li><p>筛选通过后，基于MetadataReader生成<strong>ScannedGenericBeanDefinition</strong></p></li> <li><p>再基于MetadataReader判断：</p> <ol><li>必须是<strong>独立类</strong>（可以不依赖外部类来构造，即不能是内部类，但可以是静态内部类 ）</li> <li>不能是接口或抽象类</li></ol></li> <li><p>如果筛选通过，那么就表示扫描到了一个Bean，将ScannedGenericBeanDefinition加入结果集。最后得到候选BeanDefinition集合</p></li> <li><p>遍历候选BeanDefinition集合</p> <ol><li><p>读scope注解</p></li> <li><p>根据类名生成bean名字（规则：<strong>首字母大写，直接转小写；多个大写字母开头，不转，直接用类名</strong>）</p></li> <li><p>设置BeanDefinition的默认值（不使用lazy等）</p></li> <li><p>解析@Lazy、@Primary、@DependsOn等注解（实际上都是开关），为BeanDefinition设置开关</p></li> <li><p>检查<strong>BeanDefinitionMap</strong>中是否存在同名BeanDefinition。如果存在，再看是否兼容；兼容则跳过该bean，不兼容则抛错。</p> <blockquote><p>兼容指的是该BeanDefinition与已存在的等价，或者源自同一个类</p> <p>两次扫描扫到相同bean就是兼容的，但同一次扫描扫到相同的bean就是不兼容的</p></blockquote></li> <li><p>注册到BeanDefinitionMap</p> <p>先生成BeanDefinitionHolder（其实就是BeanDefinitionMap + beanName）。如果有别名，beanName添加到<strong>别名map</strong>。最后写入DefaultListableBeanFactory的beanDefinitionMap&lt;String, BeanDefinition&gt;（ConcurrentHashMap类型）</p></li></ol></li> <li></li></ol> <p>MetadataReader表示类的元数据读取器，主要包含了一个AnnotationMetadata，功能有</p> <ol><li>获取类的名字</li> <li>获取父类的名字</li> <li>获取所实现的所有接口名</li> <li>获取所有内部类的名字</li> <li>判断是不是抽象类</li> <li>判断是不是接口</li> <li>判断是不是一个注解</li> <li>获取拥有某个注解的方法集合</li> <li>获取类上添加的所有注解信息</li> <li>获取类上添加的所有注解类型集合
合</li></ol> <p>值得注意的是，CachingMetadataReaderFactory解析某个.class文件得到MetadataReader对象是利用的ASM技术，并没有加载这个类到JVM。并且，最终得到的ScannedGenericBeanDefinition对象，beanClass属性存储的是当前类的<strong>名字</strong>，而不是class对象。（beanClass属性的类型是Object，它即可以存储类的名字，也可以存储class对象）</p> <p>最后，上面是说的通过扫描得到BeanDefinition对象，我们还可以通过直接定义BeanDefinition，或解析spring.xml文件的<bean></bean>，或者@Bean注解得到BeanDefinition对象。（后续课程会分析@Bean注解是怎么生成BeanDefinition的）。</p> <h2 id="_2-合并beandefinition"><a href="#_2-合并beandefinition" class="header-anchor">#</a> 2.合并BeanDefinition</h2> <p>实现：org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons</p> <p>遍历DefaultListableBeanFactory的beanDefinitionNames，是bean名的列表</p> <ol><li><p>获取【合并后】的BeanDefinition</p> <p>先从AbstractBeanFactory的 <strong>mergedBeanDefinitions</strong>（ConcurrentHashMap &lt;String, RootBeanDefinition&gt;）中取RootBeanDefinition</p> <p>如果取不到，递归找父BeanDefinition合并，最后用子BeanDefinition属性覆盖父BeanDefinition属性</p></li> <li><p>如果【非<strong>抽象Bean</strong> &amp;&amp; 单例 &amp;&amp; 非懒加载】，才处理</p></li> <li><p><code>isFactoryBean()</code>判断是否为FactoryBean：先从<strong>单例池</strong>找；找不到再去找BeanDefinition，再递归找父的BeanFactory。</p> <ol><li>如果是，要特殊处理：安全判断（如果系统有设置安全管理器），再看是否实现SmartFactoryBean接口（继承FactoryBean接口），有则getBean()创建bean对象（最终调用该类覆写的**getObject()**方法创建）</li> <li>如果不是，getBean()创建bean对象</li></ol> <p>所以FactoryBean很特殊，实现这个接口的bean类，可通过重写getObject()向spring容器注册自定义的bean（一般类注册的都是class为类自身的bean）</p></li> <li></li></ol> <p><strong>抽象Bean</strong></p> <p>父子BeanDefinition实际用的比较少。例如，这么定义的情况下，child是单例Bean：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>parent<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhouyu.service.Parent<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prototype<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhouyu.service.Child<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是这么定义的情况下，child就是原型Bean了 ：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>parent<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhouyu.service.Parent<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prototype<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhouyu.service.Child<span class="token punctuation">&quot;</span></span> <span class="token attr-name">parent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>parent<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因为child的父BeanDefinition是parent，所以会继承parent上所定义的scope属性。
而在根据child来生成Bean对象之前，需要进行BeanDefinition的合并，得到完整的child的
BeanDefinition  。</p> <p>抽象Bean  并不是指抽象类，而是抽象的xml bean。其唯一作用在于继承</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>parent<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhouyu.service.Parent<span class="token punctuation">&quot;</span></span> <span class="token attr-name">abstract</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhouyu.service.Child<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="getbean方法"><a href="#getbean方法" class="header-anchor">#</a> getBean方法</h3> <p>前期扫描是准备工作，这里真正开始创建bean</p> <p>AbstractBeanFactory 类的 <code>getBean(String name)</code>：返回一个bean，若容器没有就创建。</p> <p>具体逻辑在类内的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li><p>用bean名找BeanDefinition，如果没有就去父bean工厂找。</p></li> <li><p>检查@DependsOn。遍历依赖该bean的所有bean，只用名字检查，依赖关系存入dependentBeanMap中。先创建该bean依赖的bean</p></li> <li><p>开始创建，看@Scope：</p> <ol><li>是单例，getSingleton()——传入一个lambda表达式（用于回调），先锁单例池，然后看池里是否有，没有就创建后加入池。</li> <li>是原型，创建一个对象</li> <li>是其他：request或session</li></ol> <p>三种情况都调<strong>createBean()</strong>（下文3.加载类详述）</p> <p>最后都调getObjectForBeanInstance()：如果是&amp;开头，检查是否FactoryBean，不满足抛错。</p></li> <li><p>检查前几步通过name生成的beanInstance类型是否是requiredType</p></li></ol> <h2 id="_3-加载类"><a href="#_3-加载类" class="header-anchor">#</a> 3.加载类</h2> <p>BeanDefinition合并之后，就可以去创建Bean对象了。</p> <p>创建Bean就必须实例化对象，实例化就必须先加载当前BeanDefinition所对应的class，<code>AbstractAutowireCapableBeanFactory</code>类的createBean()方法中，一开始就会调用这行代码就是去加载类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果beanClass被加载了（Object beanClass属性的类型变为Class），就直接返回。否则<strong>根据bean名</strong>加载对应类
（doResolveBeanClass方法）
默认使用**ClassUtils.getDefaultClassLoader()**所返回的类加载器，如果BeanFactory有指定就用指定的类加载器。</p> <blockquote><p>ClassUtils.getDefaultClassLoader()：</p> <ol><li>优先返回当前线程中的ClassLoader</li> <li>线程中类加载器为null的情况下，返回ClassUtils类的类加载器</li> <li>如果ClassUtils类的类加载器为空，那么则表示是Bootstrap类加载器加载的ClassUtils类，那么
则返回系统类加载器</li></ol></blockquote> <h2 id="_4-实例化前"><a href="#_4-实例化前" class="header-anchor">#</a> 4.实例化前</h2> <p>当前BeanDefinition对应的类成功加载后，就可以实例化对象了。</p> <p>但是Spring在实例化对象之前，提供了一个扩展点<strong>InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()</strong>，允许用户来控制是否在某些Bean实例化之前做一些启动动作。比如下面代码会导致，在userService这个Bean实例化前打印：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;实例化前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>注意</strong></p> <p>postProcessBeforeInstantiation()是有返回值的，如果这么实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;实例化前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>userService这个Bean，在实例化前会直接返回一个由我们所定义的UserService对象。</p> <p>这种情况表示不需要Spring来实例化了，并且后续的Spring依赖注入也没了，会跳过这些步骤，直接到<strong>13.初始化后</strong>。</p> <h2 id="_5-实例化"><a href="#_5-实例化" class="header-anchor">#</a> 5.实例化</h2> <p>在这个步骤中就会根据BeanDefinition去创建一个对象了。</p> <p>实现：org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</p> <h3 id="_5-1-supplier创建对象"><a href="#_5-1-supplier创建对象" class="header-anchor">#</a> 5.1 Supplier创建对象</h3> <p>首先判断BeanDefinition中是否设置了Supplier，如果设置了则调用Supplier的get()得到对象。
​</p> <p>得直接使用BeanDefinition对象来设置Supplier，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
beanDefinition<span class="token punctuation">.</span><span class="token function">setInstanceSupplier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_5-2-工厂方法创建对象"><a href="#_5-2-工厂方法创建对象" class="header-anchor">#</a> 5.2 工厂方法创建对象</h3> <p>如果没有设置Supplier，则检查BeanDefinition中是否设置了factoryMethod，也就是工厂方法，有两种方式可以设置factoryMethod，比如：
​</p> <p>方式一：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;userService&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;com.zhouyu.service.UserService&quot;</span> factory<span class="token operator">-</span>method<span class="token operator">=</span><span class="token string">&quot;createUserService&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应的UserService类为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserService</span> <span class="token function">createUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行createUserService()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> userService<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>方式二：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;commonService&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;com.zhouyu.service.CommonService&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;userService1&quot;</span> factory<span class="token operator">-</span>bean<span class="token operator">=</span><span class="token string">&quot;commonService&quot;</span> factory<span class="token operator">-</span>method<span class="token operator">=</span><span class="token string">&quot;createUserService&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对应的CommonService的类为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonService</span> <span class="token punctuation">{</span>

 <span class="token keyword">public</span> <span class="token class-name">UserService</span> <span class="token function">createUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Spring发现当前BeanDefinition方法设置了工厂方法后，就会区分这两种方式，然后调用工厂方法得到对象。
​</p> <p>值得注意的是，我们通过@Bean所定义的BeanDefinition，是存在factoryMethod和factoryBean的，也就是和上面的方式二非常类似，@Bean所注解的方法就是factoryMethod，AppConfig对象就是factoryBean。如果@Bean所所注解的方法是static的，那么对应的就是方式一。</p> <h3 id="_5-3-推断构造方法"><a href="#_5-3-推断构造方法" class="header-anchor">#</a> 5.3 推断构造方法</h3> <p>第一节已经讲过一遍大概原理了，后面有一节课单独分析源码实现。推断完构造方法后，就会使用构造方法来进行实例化了。
​</p> <p>额外的，在推断构造方法逻辑中除开会去选择构造方法以及查找入参对象意外，会还判断是否在对应的类中是否存在使用**@Lookup注解**了方法。如果存在则把该方法封装为LookupOverride对象并添加到BeanDefinition中。
​</p> <p>在实例化时，如果判断出来当前BeanDefinition中没有LookupOverride，那就直接用构造方法反射得到一个实例对象。如果存在LookupOverride对象，也就是类中存在@Lookup注解了的方法，那就会生成一个代理对象。
​</p> <p>@Lookup注解就是<strong>方法注入</strong>，使用demo如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

 <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">OrderService</span> orderService <span class="token operator">=</span> <span class="token function">createOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>orderService<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token annotation punctuation">@Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;orderService&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">OrderService</span> <span class="token function">createOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_6-beandefinition的后置处理"><a href="#_6-beandefinition的后置处理" class="header-anchor">#</a> 6. BeanDefinition的后置处理</h2> <p>Bean对象实例化出来之后，接下来就应该给对象的属性赋值了。在真正给属性赋值之前，Spring又提供了一个扩展点<strong>MergedBeanDefinitionPostProcessor.postProcessMergedBeanDefinition()</strong>，可以对此时的BeanDefinition进行加工，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuMergedBeanDefinitionPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span> <span class="token punctuation">{</span>
 	<span class="token annotation punctuation">@Override</span>
 	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   			beanDefinition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;orderService&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		<span class="token punctuation">}</span>
 	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在Spring源码中，AutowiredAnnotationBeanPostProcessor就是一个MergedBeanDefinitionPostProcessor，它的postProcessMergedBeanDefinition()中会去查找注入点，并缓存在AutowiredAnnotationBeanPostProcessor对象的一个Map中（injectionMetadataCache）。</p> <h2 id="_7-实例化后"><a href="#_7-实例化后" class="header-anchor">#</a> 7. 实例化后</h2> <p>在处理完BeanDefinition后，Spring又设计了一个扩展点：<strong>InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()</strong>，比如：
​</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuInstantiationAwareBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
   userService<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上述代码就是对userService所实例化出来的对象进行处理。
​</p> <p>这个扩展点，在Spring源码中基本没有怎么使用。</p> <h2 id="_8-自动注入-填充属性"><a href="#_8-自动注入-填充属性" class="header-anchor">#</a> 8. 自动注入（填充属性）</h2> <p>这里的自动注入指的是Spring的自动注入，后续依赖注入课程中单独讲
​</p> <h2 id="_9-处理属性"><a href="#_9-处理属性" class="header-anchor">#</a> 9. 处理属性</h2> <p>这个步骤中，就会处理@Autowired、@Resource、@Value等注解，也是通过**InstantiationAwareBeanPostProcessor.postProcessProperties()**扩展点来实现的，比如我们甚至可以实现一个自己的自动注入功能，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuInstantiationAwareBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">PropertyValues</span> <span class="token function">postProcessProperties</span><span class="token punctuation">(</span><span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">ZhouyuInject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
      field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> pvs<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>关于@Autowired、@Resource、@Value的底层源码，会在后续的依赖注入课程中详解。</p> <h2 id="_10-执行aware"><a href="#_10-执行aware" class="header-anchor">#</a> 10. 执行Aware</h2> <p>完成了属性赋值之后，Spring会执行一些回调，包括：</p> <ol><li>BeanNameAware：回传beanName给bean对象。</li> <li>BeanClassLoaderAware：回传classLoader给bean对象。</li> <li>BeanFactoryAware：回传beanFactory给对象。</li></ol> <h2 id="_11-初始化前"><a href="#_11-初始化前" class="header-anchor">#</a> 11. 初始化前</h2> <p>初始化前，也是Spring提供的一个扩展点：<strong>BeanPostProcessor.postProcessBeforeInitialization()</strong>，比如</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;初始化前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>利用初始化前，可以对进行了依赖注入的Bean进行处理。
​</p> <p>在Spring源码中：</p> <ol><li>InitDestroyAnnotationBeanPostProcessor会在初始化前这个步骤中执行@PostConstruct的方法，</li> <li>ApplicationContextAwareProcessor会在初始化前这个步骤中进行其他Aware的回调：
<ol><li>EnvironmentAware：回传环境变量</li> <li>EmbeddedValueResolverAware：回传占位符解析器</li> <li>ResourceLoaderAware：回传资源加载器</li> <li>ApplicationEventPublisherAware：回传事件发布器</li> <li>MessageSourceAware：回传国际化资源</li> <li>ApplicationStartupAware：回传应用其他监听对象，可忽略</li> <li>ApplicationContextAware：回传Spring容器ApplicationContext</li></ol></li></ol> <h2 id="_12-初始化"><a href="#_12-初始化" class="header-anchor">#</a> 12. 初始化</h2> <ol><li>查看当前Bean对象是否实现了InitializingBean接口，如果实现了就调用其afterPropertiesSet()方法</li> <li>执行BeanDefinition中指定的初始化方法</li></ol> <h2 id="_13-初始化后"><a href="#_13-初始化后" class="header-anchor">#</a> 13. 初始化后</h2> <p>这是Bean创建生命周期中的最后一个步骤，也是Spring提供的一个扩展点：<strong>BeanPostProcessor.postProcessAfterInitialization()</strong>，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZhouyuBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;初始化后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以在这个步骤中，对Bean最终进行处理，Spring中的<strong>AOP就是基于初始化后实现</strong>的，<strong>初始化后返回的对象才是最终的Bean对象</strong>。</p> <h2 id="总结beanpostprocessor"><a href="#总结beanpostprocessor" class="header-anchor">#</a> 总结BeanPostProcessor</h2> <ol><li><p>实例化前 InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()</p></li> <li><p>实例化</p></li> <li><p>MergedBeanDefinitionPostProcessor.postProcessMergedBeanDefinition() 可以修改bdf</p></li> <li><p>实例化后 InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()  此时bean可能属性没赋值</p></li> <li><p>属性赋值（spring自带的依赖注入）</p></li> <li><p>InstantiationAwareBeanPostProcessor.postProcessProperties(@Autowired、@Resource、@Value)</p> <p>此时bean已经创建</p></li> <li><p>Aware对象</p></li> <li><p>初始化前 BeanPostProcessor.postProcessBeforeInitialization() （此时若有@PostConstruct，则执行）</p></li> <li><p>初始化</p></li> <li><p>初始化后 BeanPostProcessor.postProcessAfterInitialization()</p></li></ol> <h1 id="二、bean销毁过程"><a href="#二、bean销毁过程" class="header-anchor">#</a> 二、Bean销毁过程</h1> <p>销毁时机：容器关闭时</p> <p>销毁对象：只销毁单例，因为容器根本不存原型bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AnnotationConfigApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">AppConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 关闭容器</span>
<span class="token comment">//context.registerShutdownHook();  // 方法2：调用关闭钩子</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="扫描过程"><a href="#扫描过程" class="header-anchor">#</a> 扫描过程</h2> <p>实现：org.springframework.beans.factory.support.AbstractBeanFactory#registerDisposableBeanIfNecessary</p> <ol><li>不能是原型bean &amp;&amp; <strong>需要销毁</strong>。是否需要销毁调requiresDestruction()判断：
<ol><li>实现<strong>DisposableBean</strong>或<strong>AutoCloseable</strong>接口；</li> <li>或 bd设置了destroyMethodName属性（指定destroyMethod的方法名）。如果属性值为“(inferred)”，则自动找名为<strong>close</strong>的方法，找不到再找名为shutdown的。</li> <li>或 类实现了DestructionAwareBeanPostProcesso &amp;&amp; 其中有一个实现了DestructionAwareBeanPostProcessor.requiresDestruction()返回true（其实就是看哪些方法有**@PreDestroy**）</li></ol></li> <li>是否单例，单例才继续走（其他类型自定义处理）</li> <li>把符合上述任意一个条件的Bean适配成DisposableBeanAdapter对象，并存入<strong>disposableBeans</strong>中（一个LinkedHashMap），并不立即执行</li></ol> <h2 id="spring容器关闭过程"><a href="#spring容器关闭过程" class="header-anchor">#</a> Spring容器关闭过程</h2> <p>实现：org.springframework.context.support.AbstractApplicationContext#doClose</p> <ol><li><p>首先发布ContextClosedEvent事件</p></li> <li><p>调用lifecycleProcessor的onCloese()方法</p></li> <li><p>销毁所有单例Bean</p> <ol><li><p>遍历disposableBeans</p> <ol><li><p>把每个disposableBean从单例池中移除</p></li> <li><p>调用disposableBean的destroy()（<strong>在这里真正执行destroy逻辑</strong>）</p></li> <li><p>如果这个disposableBean还被其他Bean<strong>依赖</strong>了，先销毁其他Bean（类似拓扑排序的算法）</p></li> <li><p>如果这个disposableBean还包含了inner beans，将这些Bean从单例池中移除掉</p></li></ol> <div class="language- extra-class"><pre><code>   (inner beans是bean的所有内部类，参考https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-inner-beans)
</code></pre></div></li> <li><p>清空manualSingletonNames，是一个Set，存的是用户手动注册的单例Bean的beanName</p></li> <li><p>清空allBeanNamesByType，是一个Map &lt;bean类型，该类型所有的beanName数组&gt;</p></li> <li><p>清空singletonBeanNamesByType，和allBeanNamesByType类似，只不过只存了单例Bean</p></li></ol></li> <li><p>清空beanFactory，清空标志位</p></li></ol> <p><strong>涉及设计模式：适配器模式</strong>
在销毁时，Spring会找出实现了DisposableBean接口的Bean。
但是我们在定义一个Bean时，如果这个Bean实现了DisposableBean接口，或者实现了AutoCloseable接口，或者在BeanDefinition中指定了destroyMethodName，那么这个Bean都属于“DisposableBean”，这些Bean在容器关闭时都要调用相应的销毁方法。
所以，这里就需要进行适配，将实现了DisposableBean接口、或者AutoCloseable接口等<strong>适配成实现了DisposableBean接口</strong>，所以就用到了DisposableBeanAdapter。
会把实现了AutoCloseable接口的类封装成DisposableBeanAdapter，而DisposableBeanAdapter实现了DisposableBean接口。</p> <h1 id="三、依赖注入"><a href="#三、依赖注入" class="header-anchor">#</a> 三、依赖注入</h1> <img src="images/Spring源码/image-20230213091743919.png" alt="image-20230213091743919" style="zoom:50%;"> <p>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#populateBean</p> <h2 id="_1-已过期的-xml注入"><a href="#_1-已过期的-xml注入" class="header-anchor">#</a> 1.（已过期的）xml注入</h2> <p>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#autowireByName</p> <p>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#autowireByType</p> <p>分别处理这两种注解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>autowire <span class="token operator">=</span> <span class="token class-name">Autowire</span><span class="token punctuation">.</span><span class="token constant">BY_NAME</span><span class="token punctuation">)</span>  <span class="token comment">// 找set方法，切出set后面的名字，去找属性</span>
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>autowire <span class="token operator">=</span> <span class="token class-name">Autowire</span><span class="token punctuation">.</span><span class="token constant">BY_TYPE</span><span class="token punctuation">)</span>  <span class="token comment">// 找set方法，拿形参类型，去找属性</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>都调用unsatisfiedNonSimpleProperties()找当前Bean中能进行自动注入的属性名：</p> <ol><li>该属性有对应的set方法</li> <li>没有在<strong>ignoredDependencyTypes</strong>中</li> <li>属性对应的set方法定义的接口没有在<strong>ignoredDependencyInterfaces</strong>中</li> <li>属性类型不是简单类型及其数组，如：int、Integer、int[]</li></ol> <h2 id="_2-autowired方式"><a href="#_2-autowired方式" class="header-anchor">#</a> 2. @Autowired方式</h2> <p>@Autowired注解相当于XML中的autowire属性的<strong>注解方式的替代</strong></p> <p>由AutowiredAnnotationBeanPostProcessor处理，执行postProcessProperties()方法，会直接给对象中的属性赋值。内部并不会处理pvs，直接返回了</p> <ol><li><p>找出该类的所有注入点（@Autowired、@Value、@Inject 修饰的<strong>属性、方法</strong>），解析注入点并缓存（用于原型），生成<code>InjectedElement</code>。如果有父类，再往上找直到Object，头插法放入列表（父在前）</p> <p>static修饰的除外（原因？static修饰的属性和方法只属于类，只有一份，如果多处注入导致冲突）。String类型也除外（根本不需要注入）</p></li> <li><p>遍历1中每个注入点，对bean的执行注入</p> <ol><li>对属性，先找值，再反射set。（org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.AutowiredFieldElement#inject）</li> <li>对方法（必须是setXX），遍历参数列表找到<strong>每个参数</strong>的值，先找值，然后反射invoke调用。（org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.AutowiredMethodElement#inject）</li></ol></li></ol> <p>找值最终都调AutowireCapableBeanFactory.resolveDependency()，原型bean只在第一次执行时解析，之后有缓存了，再创建就直接取缓存</p> <p>DefaultListableBeanFactory中**resolveDependency()**是上面方法的具体实现，具体流程图  :</p> <img src="images/Spring源码/image-20230214112901786.png" alt="image-20230214112901786" style="zoom:67%;"> <p>findAutowireCandidates()</p> <p>根据类型找beanName的底层流程</p> <img src="images/Spring源码/image-20230214113440475.png" alt="image-20230214113440475"> <p>DefaultListableBeanFactory.doResolveDependency()具体流程图为</p> <img src="images/Spring源码/image-20230214112949038.png" alt="image-20230214112949038" style="zoom:50%;"> <h2 id="_3-resource注解"><a href="#_3-resource注解" class="header-anchor">#</a> 3. @Resource注解</h2> <p>由CommonAnnotationBeanPostProcessor处理，执行postProcessProperties()</p> <p>底层工作流程图</p> <img src="images/Spring源码/image-20230214113614488.png" alt="image-20230214113614488" style="zoom:80%;"> <h1 id="四、循环依赖"><a href="#四、循环依赖" class="header-anchor">#</a> 四、循环依赖</h1> <h2 id="_1-基本情形-引入earlysingletonobjects"><a href="#_1-基本情形-引入earlysingletonobjects" class="header-anchor">#</a> 1.基本情形--引入earlySingletonObjects</h2> <p>两个bean，A和B，互相@Autowired注入对方，spring创建顺序：</p> <p>先创建A，执行A的生命周期：</p> <ol><li>实例化A</li> <li>填充B属性--&gt;去单例池中找B，没有则创建B（跳到下面2.2</li> <li>填充其他属性</li> <li>初始化前、初始化、初始化后</li> <li>放入单例池</li></ol> <p>创建B，执行B的生命周期：</p> <ul><li>2.1 实例化B</li> <li>2.2 填充A属性--&gt;去单例池中找A，没有则创建A</li> <li>2.3 填充其他属性</li> <li>2.4 初始化前、初始化、 初始化后</li> <li>2.5 放入单例池</li></ul> <p>执行到2.2时，发现单例池没有A，于是死锁</p> <p>打破循环依赖的方法就是，在实例化A后，将这个未成熟的bean先放入另一个map，暂且称为<strong>早期单例池</strong>（earlySingletonObjects）。执行到2.2时，不是找单例池，而是去早期单例池找这个未成熟的A（肯定能找到）</p> <h2 id="_2-aop情形-引入singletonfactories"><a href="#_2-aop情形-引入singletonfactories" class="header-anchor">#</a> 2.AOP情形--引入singletonFactories</h2> <p>先创建A，执行A的生命周期：</p> <ol><li>实例化A--&gt;early单例池放入<strong>A原始对象</strong></li> <li>填充B属性--&gt;去单例池中找B--&gt;没有再找early单例池--&gt;没有则创建B（到2.2</li> <li>填充其他属性</li> <li>初始化前、初始化</li> <li>初始化后--&gt;<strong>A代理对象</strong></li> <li>放入单例池</li></ol> <p>创建B，执行B的生命周期：</p> <ul><li>2.1 实例化B</li> <li>2.2 填充A属性--&gt;去单例池中找A--&gt;没有再找early单例池（肯定能找到A原始对象</li> <li>2.3 填充其他属性</li> <li>2.4 初始化前、初始化、 初始化后</li> <li>2.5 放入单例池</li></ul> <p>【问题】在于第5步生成的是A代理对象，因此放入单例池的也是A代理对象，而B注入的是A原始对象，这就产生<strong>不一致冲突</strong></p> <h3 id="版本1"><a href="#版本1" class="header-anchor">#</a> 版本1</h3> <p>解决办法是<strong>提前AOP</strong>，在实例化后就执行AOP。</p> <p>再增加一个creatingSet，判断某个bean是否正在创建</p> <p>先创建A，执行A的生命周期：</p> <ol><li><p>A放入creatingSet</p></li> <li><p>实例化A--&gt;（提前AOP）early单例池放入<strong>A代理对象</strong></p></li> <li><p>填充B属性--&gt;去单例池中找B--&gt;没有再找early单例池--&gt;没有则创建B（到2.2</p> <p>后面步骤略</p></li></ol> <p>创建B，执行B的生命周期：</p> <ul><li>2.1 实例化B</li> <li>2.2 填充A属性--&gt;去单例池中找A--&gt;creatingSet中有A，说明出现循环依赖--&gt;找early单例池--&gt;<strong>A代理对象</strong>--&gt;放入</li> <li>2.3 填充其他属性</li> <li>2.4 初始化前、初始化、 初始化后</li> <li>2.5 放入单例池</li></ul> <p>注意提前AOP只是为了解决<strong>循环依赖情况下的AOP</strong>，而普通情况的AOP是不需要提前的，因此第2步还要加判断是否需要AOP，这里用了一个trick，增加一个<strong>工厂对象map&lt;bean名，ObjectFactory&lt;?&gt;&gt;</strong>，存放提前暴露的<code>ObjectFactory</code> 类型的工厂对象，也就是lambda表达式。众所周知lambda有回调函数的作用，不会立即执行，而是在未来某个需要的时机再执行，于是得到优化版本2。</p> <h3 id="版本2"><a href="#版本2" class="header-anchor">#</a> 版本2</h3> <p>先创建A，执行A的生命周期：</p> <ol><li>A放入creatingSet</li> <li>实例化A--&gt;放入工厂对象map&lt;A, lambda&lt;A原始对象&gt;&gt;</li> <li>填充B属性--&gt;去单例池中找B--&gt;没有则创建B（跳到2.2，这一步完成后得到的B是<strong>完整的bean</strong>）并放入单例池</li> <li>初始化前、初始化</li> <li>初始化后</li> <li>A放入单例池</li></ol> <p>创建B，执行B的生命周期：</p> <ul><li>2.1 实例化B</li> <li>2.2 填充A属性--&gt;去单例池中找A--&gt;creatingSet中有A，说明出现循环依赖--&gt;找early单例池--&gt;再找工厂对象map--&gt;得到lambda&lt;A原始对象&gt;--&gt;<strong>执行lambda得到A原始对象或代理对象</strong>--&gt;放入early单例池</li> <li>2.3 填充其他属性</li> <li>2.4 初始化前、初始化、 初始化后</li> <li>2.5 B放入单例池</li></ul> <h2 id="最终方案"><a href="#最终方案" class="header-anchor">#</a> 最终方案</h2> <p>于是经过两个版本迭代，得到了最终的解决方案：</p> <ol><li><p><strong>singletonObjects</strong>：（一级缓存，ConcurrentHashMap）缓存经过了完整生命周期的bean。</p></li> <li><p><strong>earlySingletonObjects</strong>：（二级缓存，HashMap）缓存未经过完整生命周期的bean。</p></li></ol> <p>如果某个bean出现了循环依赖，就会提前把这个暂时未经过完整生命周期的bean放入earlySingletonObjects中，这个bean如果要经过AOP，那么就会把代理对象放入earlySingletonObjects中，否则就是把原始对象放入earlySingletonObjects，但是不管怎么样，就是是代理对象，代理对象所代理的原始对象也是没有经过完整生命周期的，所以放入earlySingletonObjects我们就可以统一认为是未经过完整生命周期的bean。</p> <ol start="3"><li><strong>singletonFactories</strong>：（三级缓存，ConcurrentHashMap）缓存的是一个ObjectFactory，也就是一个Lambda表达式。作用是解决循环依赖时的AOP，是【兜底】的map，从里面取一定能获得bean。</li></ol> <p>在每个Bean的生成过程中，经过实例化得到一个原始对象后，都会提前基于原始对象暴露一个Lambda表达式，并保存到三级缓存中，这个Lambda表达式<strong>可能用到，也可能用不到</strong>。</p> <ol><li><p>如果当前Bean没有出现循环依赖，那么这个Lambda表达式没用，当前bean按照自己的生命周期正常执行，执行完后直接把当前bean放入singletonObjects中。</p></li> <li><p>如果当前bean在依赖注入时发现出现了循环依赖，则从三级缓存中拿到Lambda表达式，并执行Lambda表达式得到一个对象，并把得到的对象放入二级缓存（如果当前Bean需要AOP，那么执行lambda表达式，得到就是对应的代理对象；如果无需AOP，则直接得到一个原始对象）。</p></li></ol> <p>还有两个辅助数据结构：</p> <ul><li><strong>singletonsCurrentlyInCreation</strong>：集合，用于记录正在创建的bean名，bean在集合中说明出现循环依赖</li> <li><strong>earlyProxyReferences</strong>，缓存map，用来记录某个原始对象是否进行过AOP了</li></ul> <h2 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h2> <p>不管是初始化后，还是提前AOP，都是调org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#wrapIfNecessary() 来生成代理对象。</p> <h3 id="缓存流动顺序"><a href="#缓存流动顺序" class="header-anchor">#</a> 缓存流动顺序</h3> <ol><li><p>先找单例池--&gt;</p></li> <li><p>找不到，且bean被循环依赖（在creationSet中），再找二级缓存--&gt;</p></li> <li><p>找不到，对<strong>单例池加锁</strong>再找三级--&gt;</p></li> <li><p>取出lambda并执行，得到单例bean--&gt;</p></li> <li><p>放入二级缓存，并从三级移除</p> <p>前5步实现：org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(java.lang.String, boolean)</p></li> <li><p>最后放入单例池，并从二三级移除（org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#addSingleton）。</p></li></ol> <p><strong>流程图</strong></p> <img src="images/Spring源码/17395320ad095cfbtplv-t2oaga2asx-zoom-in-crop-mark3024000.webp" alt="img"> <p><code>You</code> and <code>Me</code> 的例子在注解注入造成循环依赖时，Spring的调用链时序图如下：</p> <img src="images/Spring源码/656873-20190628213759517-954779861.png" alt="img"> <h1 id="五、推断构造"><a href="#五、推断构造" class="header-anchor">#</a> 五、推断构造</h1> <h2 id="流程"><a href="#流程" class="header-anchor">#</a> 流程</h2> <p>spring实例化一个bean时，默认使用<strong>默认构造方法</strong>（未显式定义构造，由jvm生成的）。需要推断选择构造方法的几种情况：</p> <ol><li><p>有多个构造方法可选。</p></li> <li><p>getBean()可以传多个参数，<strong>第一个是beanName</strong>，后面的参数作为构造函数参数去找构造方法。</p></li> <li><p>@Autowired的构造方法有多个（只能有一个true，或者多个false，否则抛错）。</p></li> <li><p>如果不用@Component纳入容器管理，还可以用注册BeanDefinition的方式将bean纳入容器，并指定构造方法。</p> <p>从容器中获取UserService，直接用名字找，不加其他参数。在一般情况下，spring肯定会调用无参构造。</p> <p>对BeanDefinition的<strong>constructorArgumentValues</strong>做修改，可以指定spring调用的构造。有addGenericArgumentValue和addIndexedArgumentValue两种</p> <p>例：UserService有三种构造方法，参数分别为0，1，2个</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span>  <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>orderService <span class="token operator">=</span> orderService<span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token class-name">OrderService</span> orderService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>orderService <span class="token operator">=</span> orderService<span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token class-name">OrderService</span> orderService<span class="token punctuation">,</span> <span class="token class-name">OrderService</span> orderService1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>orderService <span class="token operator">=</span> orderService<span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;test &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>orderService<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>1）<code>addGenericArgumentValue(Object val)</code>方法。</p> <p>为构造方法的指定入参val，默认从左到右</p> <p>第9行为构造方法添加了一个OrderService对象作为参数，调用的构造方法就是一个参数的（打印1）。</p> <p>如果第10行再增加一个参数，调用的构造方法就是两个参数的（打印2）。</p> <p>如果UserService加了@Component，getBean之后还会再调用一次无参构造（打印0）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 创建一个Spring容器</span>
   <span class="token class-name">AnnotationConfigApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   context<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">AppConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 通过beanDefinition指定构造方法</span>
   <span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinition<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addGenericArgumentValue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// beanDefinition.getConstructorArgumentValues().addGenericArgumentValue(new OrderService());</span>
   context<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
   context<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
   userService<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>2）<code>addIndexedArgumentValue(int i, Object val)</code>方法。</p> <p>为构造方法的第i个参数指定入参val</p> <p>例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 创建一个Spring容器</span>
   <span class="token class-name">AnnotationConfigApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">AppConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 通过beanDefinition指定构造方法</span>
   <span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinition<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 为构造方法的第0个参数指定入参</span>
   context<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   userService<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>会调用1个参数的构造。</p> <p>如果是下列设置：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//会报错，因为第0个参数未指定</span>
<span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 也会报错，同样因为第0个参数未指定</span>
<span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 会调用2个参数的构造。</span>
<span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ol> <p>实例化时（org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBeanInstance），调determineConstructorsFromBeanPostProcessors()找所有候选的构造方法，思路见下图：</p> <img src="images/Spring源码/image-20230221165332634.png" alt="image-20230221165332634"> <p>候选的构造方法为null，则直接使用无参构造。否则调</p> <img src="images/Spring源码/image-20230222090947075.png" alt="image-20230222090947075"> <img src="images/Spring源码/image-20230222091016515.png" alt="image-20230222091016515"> <h2 id="优先级"><a href="#优先级" class="header-anchor">#</a> 优先级</h2> <p>@Autowired指定  &gt; getBean()指定 &gt; beanDefinition指定</p> <ol><li>加@Autowired构造的直接选中。</li> <li>getBean()只有beanName参数时，再看beanDefinition。若beanDefinition指定AutowireMode为<strong>AUTOWIRE_CONSTRUCTOR</strong>，则优先选public构造，再看参数个数最多的。</li> <li>若beanDefinition未指定AUTOWIRE_CONSTRUCTOR，则看ConstructorArgumentValues是否添加了参数</li></ol> <p>例：</p> <p>使用beanDefinition定义。getBean无参时：优先选public构造，再看参数个数最多的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
beanDefinition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
beanDefinition<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIndexedArgumentValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

beanDefinition<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定AutowireMode</span>
context<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调3参数</span>
userService<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果这样写，调2参数</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样写调1参数</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="宽松模式和严格模式"><a href="#宽松模式和严格模式" class="header-anchor">#</a> 宽松模式和严格模式</h2> <ul><li><p>宽松模式（默认）会看参数类型的继承和实现，根据规则算分，最后选分最小的构造方法</p> <p>规则：父类+2分，接口+1分，恰好匹配+0分</p></li> <li><p>严格模式要精确匹配</p></li></ul> <h1 id="六、启动过程"><a href="#六、启动过程" class="header-anchor">#</a> 六、启动过程</h1> <p><code>JarLauncher</code> 类有一个 <code>main</code> 方法，这也是为什么 <code>java -jar</code> 命令可以进行引导的原因，毕竟 <code>java</code> 程序都是通过 <code>main</code> 方法进行运行的。在执行 <code>java -jar</code> 的时候，根据 <code>java</code> 官方规范会引导 <code>jar</code> 包里面 <code>MANIFEST.MF</code> 文件中的 <code>Main-Class</code> 属性对应的启动类，该启动类中必须包含 <code>main()</code> 方法。</p> <p>SpringBoot 项目构建的 jar 包，除了 <code>Main-Class</code> 属性外还会有一个 <code>Start-Class</code> 属性绑定的是我们项目的启动类，当我们在执行 <code>java -jar</code> 的时候优先引导的是 <code>org.springframework.boot.loader.JarLauncher#main</code> 方法，该方法内部会通过引导 <code>Start-Class</code> 属性来启动我们的应用代码。</p> <h2 id="q-spring的main方法如何执行"><a href="#q-spring的main方法如何执行" class="header-anchor">#</a> Q：spring的main方法如何执行？</h2> <p>tomcat</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/24/2024, 1:37:35 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/CS-Note/assets/js/app.499d959b.js" defer></script><script src="/CS-Note/assets/js/2.3a0ab2ea.js" defer></script><script src="/CS-Note/assets/js/1.2a19e319.js" defer></script><script src="/CS-Note/assets/js/37.e0c6270e.js" defer></script>
  </body>
</html>
