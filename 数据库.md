# 数据库

## 事务

### ACID原则

A原子性：事务是最小的执行单位，不可分割。由undo log日志保证，它记录了需要回滚的日志信息，事务回滚时撤销已经执行成功的sql

C一致性：数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对同一个数据的读取结果都是相同的。一般由代码层面来保证

I隔离性：一个事务所做的修改在提交前，对其它事务是不可见。由MVCC来保证

D持久性：一旦事务提交，则其所做的修改永远保存到数据库中。即使系统崩溃，事务执行的结果也不能丢失。由内存+redo log来保证，mysql修改数据同时在内存和redo log记录这次操作，事务提交的时候通过redo log刷盘，宕机的时候可以从redo log恢复

### 隔离级别

表示并发事务对同一资源读取的隔离程度，由低到高依次是：

 

#### 未提交读（READ UNCOMMITTED）

事务中的修改，即使没有提交，对其它事务也是可见的。



#### 提交读（READ COMMITTED）

一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。Oracle 默认采用的是该隔离级别

 

#### 可重复读（REPEATABLE READ）

保证在同一个事务中多次读取同一数据的结果是一样的。MySQL 默认采用可重复读隔离级别。

 

#### 可串行化（SERIALIZABLE）

强制事务串行执行，这样多个事务互不干扰，不会出现并发一致性问题。

该隔离级别需要加锁实现，因为要使用加锁机制保证同一时间只有一个事务执行，也就是保证事务串行执行。

 

#### 各种级别能否解决一致性问题


| 隔离级别 | 脏读 | 不可重复读 | 幻读 | 丢失更新 |
| -------- | ---- | ---------- | ---- | -------- |
| 未提交读 | 否   | 否         | 否   | 否       |
| 提交读   | 能   | 否         | 否   | 否       |
| 可重复读 | 能   | 能         | 否   | 能       |
| 可串行化 | 能   | 能         | 能   | 能       |

## 最左前缀匹配原则

最左优先，以最左边的为起点任何连续的索引都能匹配上。同时遇到范围查询(>、<、between、like)就会停止匹配。（注意是索引顺序的最左，与查询条件的顺序无关，因为优化器能调整条件的顺序）

例如：1、如果建立(a,b)顺序的索引，我们的条件只有b=xxx，是匹配不到(a,b)索引的；

2、若查询条件是a = 1 and b = 2或者b=2 and a=1就可以，因为优化器会自动调整a,b的顺序，并不需要严格按照索引的顺序来；

3、如a = 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，因为c字段是一个范围查询，它之后的字段会停止匹配。而索引(a,b,d,c)能被用到，因为范围查询的c列在索引的最后，且条件a、b、c的顺序能任意调整

 

### 原理

索引的底层是一颗B+树，那么联合索引也还是一颗B+树，只不过联合索引的健值数量不是一个，而是多个。构建一颗B+树只能根据一个值来构建，因此数据库依据联合索引最左的字段来构建B+树。

例如联合索引(a,b)的B+树：

先按a值排序，当a值相等时，才按b值排序。因此当a用范围查询时，b是无序的，无法使用索引，即索引某列是**范围查询**时，其右侧的列无法使用索引。

 

### 注意

只是MySQL有这个限制，Oracle任意顺序都可以