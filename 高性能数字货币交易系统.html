<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机面试指北</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="计算机面试指北">
    
    <link rel="preload" href="/CS-Note/assets/css/0.styles.37b6130a.css" as="style"><link rel="preload" href="/CS-Note/assets/js/app.499d959b.js" as="script"><link rel="preload" href="/CS-Note/assets/js/2.3a0ab2ea.js" as="script"><link rel="preload" href="/CS-Note/assets/js/1.2a19e319.js" as="script"><link rel="preload" href="/CS-Note/assets/js/22.8a129fa2.js" as="script"><link rel="prefetch" href="/CS-Note/assets/js/10.d51ac22e.js"><link rel="prefetch" href="/CS-Note/assets/js/11.b53fe42a.js"><link rel="prefetch" href="/CS-Note/assets/js/12.7aa00c78.js"><link rel="prefetch" href="/CS-Note/assets/js/13.67223a8e.js"><link rel="prefetch" href="/CS-Note/assets/js/14.207a62d8.js"><link rel="prefetch" href="/CS-Note/assets/js/15.13447313.js"><link rel="prefetch" href="/CS-Note/assets/js/16.5f3d6fd5.js"><link rel="prefetch" href="/CS-Note/assets/js/17.56e70d25.js"><link rel="prefetch" href="/CS-Note/assets/js/18.f14668a4.js"><link rel="prefetch" href="/CS-Note/assets/js/19.fd36e329.js"><link rel="prefetch" href="/CS-Note/assets/js/20.ac1cf63f.js"><link rel="prefetch" href="/CS-Note/assets/js/21.c82e808b.js"><link rel="prefetch" href="/CS-Note/assets/js/23.4bc57570.js"><link rel="prefetch" href="/CS-Note/assets/js/24.73b21b26.js"><link rel="prefetch" href="/CS-Note/assets/js/25.b8611692.js"><link rel="prefetch" href="/CS-Note/assets/js/26.a296c369.js"><link rel="prefetch" href="/CS-Note/assets/js/27.42b29ccc.js"><link rel="prefetch" href="/CS-Note/assets/js/28.f5d9ff11.js"><link rel="prefetch" href="/CS-Note/assets/js/29.734fa758.js"><link rel="prefetch" href="/CS-Note/assets/js/3.9d4db8bf.js"><link rel="prefetch" href="/CS-Note/assets/js/30.17548d71.js"><link rel="prefetch" href="/CS-Note/assets/js/31.3dc09066.js"><link rel="prefetch" href="/CS-Note/assets/js/32.0fe7da6f.js"><link rel="prefetch" href="/CS-Note/assets/js/33.a522da37.js"><link rel="prefetch" href="/CS-Note/assets/js/34.09c983b1.js"><link rel="prefetch" href="/CS-Note/assets/js/35.e76434f5.js"><link rel="prefetch" href="/CS-Note/assets/js/36.39026a8c.js"><link rel="prefetch" href="/CS-Note/assets/js/37.e0c6270e.js"><link rel="prefetch" href="/CS-Note/assets/js/38.a3b88467.js"><link rel="prefetch" href="/CS-Note/assets/js/39.cbbe4c99.js"><link rel="prefetch" href="/CS-Note/assets/js/4.eed64932.js"><link rel="prefetch" href="/CS-Note/assets/js/40.32d35e6a.js"><link rel="prefetch" href="/CS-Note/assets/js/41.96ec4146.js"><link rel="prefetch" href="/CS-Note/assets/js/42.1c7206ce.js"><link rel="prefetch" href="/CS-Note/assets/js/43.9cf3acc6.js"><link rel="prefetch" href="/CS-Note/assets/js/44.de1adacc.js"><link rel="prefetch" href="/CS-Note/assets/js/45.0d47c93a.js"><link rel="prefetch" href="/CS-Note/assets/js/46.6109a5cc.js"><link rel="prefetch" href="/CS-Note/assets/js/47.e3ee1a02.js"><link rel="prefetch" href="/CS-Note/assets/js/48.7c856d25.js"><link rel="prefetch" href="/CS-Note/assets/js/49.08d863fe.js"><link rel="prefetch" href="/CS-Note/assets/js/5.8ea92bac.js"><link rel="prefetch" href="/CS-Note/assets/js/50.b38b6f84.js"><link rel="prefetch" href="/CS-Note/assets/js/51.eb35dbda.js"><link rel="prefetch" href="/CS-Note/assets/js/6.7df2cbe2.js"><link rel="prefetch" href="/CS-Note/assets/js/7.e0fadba1.js"><link rel="prefetch" href="/CS-Note/assets/js/vendors~docsearch.2493936b.js">
    <link rel="stylesheet" href="/CS-Note/assets/css/0.styles.37b6130a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CS-Note/" class="home-link router-link-active"><img src="images/hero.png" alt="计算机面试指北" class="logo"> <span class="site-name can-hide">计算机面试指北</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CS-Note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java并发.html" class="nav-link">
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java高级.html" class="nav-link">
  Java高级
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常见问题.html" class="nav-link">
  Spring常见问题
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常用注解.html" class="nav-link">
  Spring常用注解
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring源码.html" class="nav-link">
  Spring源码
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring事务.html" class="nav-link">
  Spring事务
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix实战.html" class="nav-link">
  SpringCloud-Netflix实战
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix源码.html" class="nav-link">
  SpringCloud-Netflix源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/存储.html" class="nav-link">
  存储
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/计算机网络.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/操作系统.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/分布式.html" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/消息队列.html" class="nav-link">
  消息队列
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/注册中心.html" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/容器.html" class="nav-link">
  容器
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/RPC.html" class="nav-link">
  RPC
</a></li></ul></div></div><div class="nav-item"><a href="/CS-Note/算法.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/系统设计.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/信息doc安全.html" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/编码.html" class="nav-link">
  编码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目" class="mobile-dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/高性能数字货币交易系统.html" class="nav-link">
  高性能数字货币交易系统
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/手写Spring.html" class="nav-link">
  手写Spring
</a></li></ul></div></div> <a href="https://github.com/caisense/CS-Note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CS-Note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Java基础.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java并发.html" class="nav-link">
  Java并发
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Java高级.html" class="nav-link">
  Java高级
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow down"></span></button> <button type="button" aria-label="Spring" class="mobile-dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常见问题.html" class="nav-link">
  Spring常见问题
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring常用注解.html" class="nav-link">
  Spring常用注解
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring源码.html" class="nav-link">
  Spring源码
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Spring事务.html" class="nav-link">
  Spring事务
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix实战.html" class="nav-link">
  SpringCloud-Netflix实战
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/SpringCloud-Netflix源码.html" class="nav-link">
  SpringCloud-Netflix源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/数据库.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/存储.html" class="nav-link">
  存储
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/计算机网络.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/操作系统.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow down"></span></button> <button type="button" aria-label="分布式" class="mobile-dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/分布式.html" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Redis.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/消息队列.html" class="nav-link">
  消息队列
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/注册中心.html" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/容器.html" class="nav-link">
  容器
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/RPC.html" class="nav-link">
  RPC
</a></li></ul></div></div><div class="nav-item"><a href="/CS-Note/算法.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/设计模式.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/系统设计.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Linux.html" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/信息doc安全.html" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/编码.html" class="nav-link">
  编码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><span class="title">项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目" class="mobile-dropdown-title"><span class="title">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CS-Note/高性能数字货币交易系统.html" class="nav-link">
  高性能数字货币交易系统
</a></li><li class="dropdown-item"><!----> <a href="/CS-Note/手写Spring.html" class="nav-link">
  手写Spring
</a></li></ul></div></div> <a href="https://github.com/caisense/CS-Note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_0-架构设计" class="sidebar-link">0.架构设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#基于数据库" class="sidebar-link">基于数据库</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#基于内存撮合" class="sidebar-link">基于内存撮合</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#基于内存撮合清算" class="sidebar-link">基于内存撮合清算</a></li></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_1-定序系统" class="sidebar-link">1.定序系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-如何在定序器重启后正确初始化下一个序列号" class="sidebar-link">Q：如何在定序器重启后正确初始化下一个序列号？</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-如何在定序器崩溃后自动恢复" class="sidebar-link">Q：如何在定序器崩溃后自动恢复？</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-如何解决定序的性能瓶颈" class="sidebar-link">Q：如何解决定序的性能瓶颈？</a></li></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_2-交易引擎" class="sidebar-link">2.交易引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_2-1-资产系统" class="sidebar-link">2.1.资产系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-为什么不使用数据库" class="sidebar-link">Q：为什么不使用数据库？</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-为什么要使用concurrentmap" class="sidebar-link">Q：为什么要使用ConcurrentMap？</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-如何扩展以支持更多的资产类型" class="sidebar-link">Q：如何扩展以支持更多的资产类型？</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_2-2-订单系统" class="sidebar-link">2.2.订单系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-order的id和sequenceid为何不合并使用一个id" class="sidebar-link">Q：Order的id和sequenceId为何不合并使用一个ID？</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_2-3-撮合引擎" class="sidebar-link">2.3 撮合引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#订单薄orderbook" class="sidebar-link">订单薄OrderBook</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#撮合引擎matchengine" class="sidebar-link">撮合引擎MatchEngine</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_2-4-清算系统" class="sidebar-link">2.4 清算系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#买入" class="sidebar-link">买入</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#卖出" class="sidebar-link">卖出</a></li></ul></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_2-5-完成交易引擎" class="sidebar-link">2.5 完成交易引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#整合定序系统" class="sidebar-link">整合定序系统</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#异步处理" class="sidebar-link">异步处理</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#验证模块" class="sidebar-link">验证模块</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-交易引擎崩溃后如何恢复" class="sidebar-link">Q：交易引擎崩溃后如何恢复？</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#q-如果现有的交易事件太多-恢复需要花费几天-怎么办" class="sidebar-link">Q：如果现有的交易事件太多，恢复需要花费几天，怎么办？</a></li></ul></li></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_3-api系统" class="sidebar-link">3.API系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#编写api-controller" class="sidebar-link">编写API Controller</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#如何实现api-key认证" class="sidebar-link">如何实现API Key认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#内部系统调用api如何实现用户认证" class="sidebar-link">内部系统调用API如何实现用户认证</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#如何跟踪api性能" class="sidebar-link">如何跟踪API性能</a></li></ul></li></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_4-行情系统" class="sidebar-link">4.行情系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#缓存redis" class="sidebar-link">缓存redis</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#编写quotationservice" class="sidebar-link">编写QuotationService</a></li></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_5-推送系统" class="sidebar-link">5.推送系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#pushservice" class="sidebar-link">PushService</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#pushverticle" class="sidebar-link">PushVerticle</a></li></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_6-ui系统" class="sidebar-link">6.ui系统</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#_7-总结" class="sidebar-link">7.总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#网关" class="sidebar-link">网关</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#远程调用" class="sidebar-link">远程调用</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#系统监控" class="sidebar-link">系统监控</a></li><li class="sidebar-sub-header"><a href="/CS-Note/%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%97%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F.html#密钥管理" class="sidebar-link">密钥管理</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>声明：本文是对廖雪峰大神的 <a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1266263401691296" target="_blank" rel="noopener noreferrer">Spring Cloud教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的学习笔记，仅限于学习交流之用途！</p> <h1 id="_0-架构设计"><a href="#_0-架构设计" class="header-anchor">#</a> 0.架构设计</h1> <div class="language-ascii line-numbers-mode"><pre class="language-text"><code>           1  ┌───────────┐  2  ┌───────────┐  7  ┌───────────┐
Request  ────&gt;│   User    │────&gt;│  Account  │&lt;────│ Clearing  │
              └───────────┘     └───────────┘     └───────────┘
                                     3│                 ▲
                                      ▼                 │
                                ┌───────────┐           │
                                │   Order   │          6│
                                └───────────┘           │
                                     4│                 │
                                      ▼                 │
                                ┌───────────┐  5  ┌───────────┐
                                │ Sequence  │────&gt;│   Match   │
                                └───────────┘     └───────────┘
                                                        │
                                                        ▼
                                                  ┌───────────┐
Market   &lt;────────────────────────────────────────│ Quotation │
                                                  └───────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>当一个请求进入交易系统后，首先由用户系统（User）识别用户身份，然后由账户系统（Account）对用户资产进行冻结，买入冻结USD，卖出冻结BTC，冻结如果成功，订单就进入定序系统（Sequence）。</p> <p>经过定序的订单被送入撮合引擎（Match）。</p> <p>当撮合引擎输出了成交结果后，该成交记录由清算系统（Clearing）进行清算。清算的工作就是把买单冻结的USD扣掉，并加上买入所得的BTC，同时，把卖单冻结的BTC扣掉，并加上卖出所得的USD。根据taker／maker的费率，向买卖双方收取手续费。</p> <p>清算系统完成清算后，更新订单状态，再通知用户，用户就可以查询到买卖的成交情况。</p> <p>在撮合引擎输出成交记录给清算系统的同时，它还把去除用户和订单相关信息的成交记录输出给行情系统（Quotation），由行情系统保存市场的成交价、成交量等信息，并输出实时价格、K线图等技术数据，以便公开市场查询。</p> <h2 id="基于数据库"><a href="#基于数据库" class="header-anchor">#</a> 基于数据库</h2> <p>订单全部存入数据库，并且，每次撮合都基于数据库的订单进行排序，这种完全基于数据库操作，并通过数据库事务保证数据一致性的交易系统，显然性能有限，并且，对数据库的硬件配置有非常高的要求。实际上，这种交易系统的处理能力每秒在100左右，提升系统性能完全依靠数据库服务器的硬件升级</p> <h2 id="基于内存撮合"><a href="#基于内存撮合" class="header-anchor">#</a> 基于内存撮合</h2> <p>使用内存撮合的订单处理速度每秒可高达100万，但清算仍然是基于数据库事务，是整个系统的瓶颈，因此，系统的订单处理能力大约能提升到每秒1000单</p> <h2 id="基于内存撮合清算"><a href="#基于内存撮合清算" class="header-anchor">#</a> 基于内存撮合清算</h2> <p>全内存模型和前面两种设计模型有个很大的区别，就是并不需要多线程并发处理，而是依赖<strong>单线程无锁模型</strong>，让所有计算全部在内存中完成，反而可以轻松获得10万+的量级。</p> <p>好处是极高的处理速度，此外另一个好处是硬件成本很低，原因是内存非常便宜，单机32G内存就可以轻松实现每秒10万的订单处理速度。注意这里的每秒10万订单是指用户下单到订单撮合、清算全部完毕的整个流程，而不是单独指某个模块的处理速度。</p> <p>缺点是由于内存的易失性，因为不再通过数据库事务保证数据一致性，如果遭遇宕机、断电等系统故障，交易系统必须能可靠地恢复整个系统的状态</p> <h1 id="_1-定序系统"><a href="#_1-定序系统" class="header-anchor">#</a> 1.定序系统</h1> <p>为什么需要设计一个定序系统？因为交易系统的所有订单是一个有序队列。不同的用户在同一时刻下单，也必须由定序系统确定先后顺序。</p> <p>首先定义要接收的事件消息，它包含一个Sequence ID、上一个Sequence ID以及一个可选的用于去重的全局唯一ID：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbstractEvent</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessage</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定序后的Sequence ID:</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> sequenceId<span class="token punctuation">;</span>
    <span class="token comment">// 定序后的Previous Sequence ID:</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> previousId<span class="token punctuation">;</span>
    <span class="token comment">// 可选的全局唯一标识:</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> uniqueId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>定序系统接收的事件仅包含可选的<code>uniqueId</code>，忽略<code>sequenceId</code>和<code>previousId</code>。定序完成后，把<code>sequenceId</code>和<code>previousId</code>设置好，再发送给下游。</p> <p><code>SequenceService</code>用于接收上游消息、定序、发送消息给下游：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SequenceService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">SequenceHandler</span> sequenceHandler<span class="token punctuation">;</span>
    <span class="token comment">// 全局唯一递增ID:</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> sequence<span class="token punctuation">;</span>
    <span class="token comment">// 接收消息并定序再发送:</span>
    <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">processMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定序后的事件消息:</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> sequenced <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 定序:</span>
            sequenced <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceHandler<span class="token punctuation">.</span><span class="token function">sequenceMessages</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageTypes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequence<span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 定序出错时进程退出:</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;exception when do sequence&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 发送定序后的消息:</span>
        <span class="token function">sendMessages</span><span class="token punctuation">(</span>sequenced<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>SequenceHandler</code>是真正写入Sequence ID并落库的，在<code>SequenceService</code>中调用<code>SequenceHandler</code>是因为我们写入数据库时需要利用Spring提供的声明式数据库事务，而消息的接收和发送并不需要被包含在数据库事务中。</p> <h2 id="q-如何在定序器重启后正确初始化下一个序列号"><a href="#q-如何在定序器重启后正确初始化下一个序列号" class="header-anchor">#</a> Q：如何在定序器重启后正确初始化下一个序列号？</h2> <p>正确初始化下一个序列号实际上就是要把一个正确的初始值给<code>AtomicLong sequence</code>字段。可以读取数据库获得当前最大的Sequence ID，这个Sequence ID就是上次最后一次定序的ID。</p> <h2 id="q-如何在定序器崩溃后自动恢复"><a href="#q-如何在定序器崩溃后自动恢复" class="header-anchor">#</a> Q：如何在定序器崩溃后自动恢复？</h2> <p>由于任何一个时候都只能有一个定序器工作，这样才能保证Sequence ID的正确性，因此，无法让两个定序器同时工作。</p> <p>虽然无法让两个定序器同时工作，但可以让两个定序器以主备模式同时运行，仅主定序器工作。当主定序器崩溃后，备用定序器自动切换为主定序器接管后续工作即可。</p> <p>为了实现主备模式，可以启动两个定序器，然后抢锁的形式确定主备。抢到锁的定序器开始工作，并定期刷新锁，未抢到锁的定序器定期检查锁。可以用数据库锁实现主备模式。</p> <h2 id="q-如何解决定序的性能瓶颈"><a href="#q-如何解决定序的性能瓶颈" class="header-anchor">#</a> Q：如何解决定序的性能瓶颈？</h2> <p>通常来说，消息系统的吞吐量远超数据库。定序的性能取决于批量写入数据库的能力。首先要<strong>提高数据库的性能</strong>，其次考虑按Sequence ID进行分库，但分库会提高定序的复杂度，也会使下游从数据库读取消息时复杂度增加。最后，可以考虑使用专门针对时序优化的数据库，但这样就不如MySQL这种数据库通用、易用。</p> <h1 id="_2-交易引擎"><a href="#_2-交易引擎" class="header-anchor">#</a> 2.交易引擎</h1> <h2 id="_2-1-资产系统"><a href="#_2-1-资产系统" class="header-anchor">#</a> 2.1.资产系统</h2> <p><strong>用户资产</strong>：用户以各种方式将USD、BTC充入交易所后的余额</p> <p>用户在买入BTC时，需要花费USD，而卖出BTC后，获得USD。当用户下单买入时，系统会先冻结对应的USD金额；当用户下单卖出时，系统会先冻结对应的BTC。</p> <blockquote><p>之所以需要有<strong>冻结</strong>这一操作，是因为判断能否下单成功，是根据用户的可用资产判断。每下一个新的订单，就会有一部分可用资产被冻结，因此，用户资产本质上是一个由用户ID和资产ID标识的二维表。</p></blockquote> <p>使用双层map表示资产： <code>用户ID -&gt; (资产ID -&gt; Asset)</code></p> <p>在<code>AssetService</code>上定义对用户资产的操作。实际上，所有资产操作只有一种操作，即转账。转账类型可用<code>Transfer</code>定义为枚举类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Transfer</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可用转可用:</span>
    <span class="token constant">AVAILABLE_TO_AVAILABLE</span><span class="token punctuation">,</span>
    <span class="token comment">// 可用转冻结:</span>
    <span class="token constant">AVAILABLE_TO_FROZEN</span><span class="token punctuation">,</span>
    <span class="token comment">// 冻结转可用:</span>
    <span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>转账操作只需要一个<code>tryTransfer()</code>方法，实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryTransfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span> type<span class="token punctuation">,</span> <span class="token class-name">Long</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">Long</span> toUser<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span> assetId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkBalance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 转账金额不能为负:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Negative amount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取源用户资产:</span>
    <span class="token class-name">Asset</span> fromAsset <span class="token operator">=</span> <span class="token function">getAsset</span><span class="token punctuation">(</span>fromUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fromAsset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 资产不存在时初始化用户资产:</span>
        fromAsset <span class="token operator">=</span> <span class="token function">initAssets</span><span class="token punctuation">(</span>fromUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取目标用户资产:</span>
    <span class="token class-name">Asset</span> toAsset <span class="token operator">=</span> <span class="token function">getAsset</span><span class="token punctuation">(</span>toUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toAsset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 资产不存在时初始化用户资产:</span>
        toAsset <span class="token operator">=</span> <span class="token function">initAssets</span><span class="token punctuation">(</span>toUser<span class="token punctuation">,</span> assetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">AVAILABLE_TO_AVAILABLE</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 需要检查余额且余额不足:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBalance <span class="token operator">&amp;&amp;</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 转账失败:</span>
                <span class="token keyword">yield</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 源用户的可用资产减少:</span>
            fromAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 目标用户的可用资产增加:</span>
            toAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> toAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回成功:</span>
            <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            <span class="token comment">// 从可用转至冻结:</span>
        <span class="token keyword">case</span> <span class="token constant">AVAILABLE_TO_FROZEN</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBalance <span class="token operator">&amp;&amp;</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            fromAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> fromAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            toAsset<span class="token punctuation">.</span>frozen <span class="token operator">=</span> toAsset<span class="token punctuation">.</span>frozen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            <span class="token comment">// 从冻结转至可用:</span>
        <span class="token keyword">case</span> <span class="token constant">FROZEN_TO_AVAILABLE</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBalance <span class="token operator">&amp;&amp;</span> fromAsset<span class="token punctuation">.</span>frozen<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            fromAsset<span class="token punctuation">.</span>frozen <span class="token operator">=</span> fromAsset<span class="token punctuation">.</span>frozen<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            toAsset<span class="token punctuation">.</span>available <span class="token operator">=</span> toAsset<span class="token punctuation">.</span>available<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid type: &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>除了用户存入资产时，需要调用<code>tryTransfer()</code>并且不检查余额，因为此操作是从系统负债账户向用户转账，其他常规转账操作均需要检查余额：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span> type<span class="token punctuation">,</span> <span class="token class-name">Long</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">Long</span> toUser<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span> assetId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryTransfer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> fromUser<span class="token punctuation">,</span> toUser<span class="token punctuation">,</span> assetId<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Transfer failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>冻结和解冻操作，其实都是在<code>tryTransfer()</code>基础上封装。</p> <p>测试验证：交易所要保证任意操作后，所有用户资产的各余额总和为0（有一个特殊账户--系统账户，用户充值实际上是系统账户对用户账户转账，整个系统无外部金额输入，总和应为0）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AssetServiceTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">tryTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="q-为什么不使用数据库"><a href="#q-为什么不使用数据库" class="header-anchor">#</a> Q：为什么不使用数据库？</h3> <p>因为我们要实现的交易引擎是100%全内存交易引擎，因此所有用户资产均存放在内存中，无需访问数据库。</p> <h3 id="q-为什么要使用concurrentmap"><a href="#q-为什么要使用concurrentmap" class="header-anchor">#</a> Q：为什么要使用ConcurrentMap？</h3> <p><strong>并不是为了让多线程并发写入，而是为了多线程读</strong></p> <p>使用<code>ConcurrentMap</code>并不是为了让多线程并发写入，因为<code>AssetService</code>中并没有任何同步锁。对<code>AssetService</code>进行写操作必须是单线程，不支持多线程调用<code>tryTransfer()</code>。</p> <p>但是读取Asset支持多线程并发读取，这也是使用<code>ConcurrentMap</code>的原因。如果改成<code>HashMap</code>，根据不同JDK版本的实现不同，多线程读取<code>HashMap</code>可能造成死循环（注意这不是<code>HashMap</code>的bug），必须引入同步机制。</p> <h3 id="q-如何扩展以支持更多的资产类型"><a href="#q-如何扩展以支持更多的资产类型" class="header-anchor">#</a> Q：如何扩展以支持更多的资产类型？</h3> <p>我们在<code>AssetEnum</code>中以枚举方式定义了USD和BTC两种资产，如果要扩展到更多资产类型，可以以整型ID作为资产ID，同时需要管理一个资产ID到资产名称的映射，这样可以在业务需要的时候更改资产名称。</p> <h2 id="_2-2-订单系统"><a href="#_2-2-订单系统" class="header-anchor">#</a> 2.2.订单系统</h2> <p>一个订单由订单ID唯一标识。为简化设计，该对象既作为订单系统的订单对象，也作为数据库映射实体。包含以下重要字段：</p> <ul><li>userId：订单关联的用户ID；</li> <li>sequenceId：定序ID，相同价格的订单根据定序ID进行排序；</li> <li>direction：订单方向：买或卖；</li> <li>price：订单价格；</li> <li>quantity：订单数量；</li> <li>unfilledQuantity：尚未成交的数量；</li> <li>status：订单状态，包括等待成交、部分成交、完全成交、部分取消、完全取消。</li></ul> <p>创建订单：先<strong>冻结</strong>要交易的资产（买入冻结USD，卖出冻结BTC），再创建。一个订单被成功创建后，它后续由撮合引擎处理时，只有<code>unfilledQuantity</code>和<code>status</code>会发生变化，其他属性均为只读，不会改变。</p> <p>删除订单：当订单状态变为完全成交、部分取消、完全取消时，订单就已经处理完成。处理完成的订单从订单系统中删除，并写入数据库永久变为历史订单。用户查询活动订单时，需要读取订单系统，用户查询历史订单时，只需从数据库查询，就与订单系统无关了。</p> <p>根据业务需要，订单系统需要支持：</p> <ul><li>根据订单ID查询到订单；</li> <li>根据用户ID查询到该用户的所有活动订单。</li></ul> <p>因此，<code>OrderService</code>需要用两个<code>Map</code>存储活动订单：</p> <p>activeOrders：跟踪所有活动订单<code>map&lt;OrderID, OrderEntity&gt;</code></p> <p>userOrders：二维map，跟踪用户活动订单<code>map&lt;UserID, Map&lt;OrderID, OrderEntity&gt;&gt;</code></p> <p>添加和删除Order，要更新这两个map。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 创建订单，失败返回null:
 */</span>
<span class="token keyword">public</span> <span class="token class-name">OrderEntity</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token keyword">long</span> ts<span class="token punctuation">,</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Direction</span> direction<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> quantity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 买入，需冻结USD：</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>assetService<span class="token punctuation">.</span><span class="token function">tryFreeze</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 卖出，需冻结BTC：</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>assetService<span class="token punctuation">.</span><span class="token function">tryFreeze</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">BTC</span><span class="token punctuation">,</span> quantity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid direction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 实例化Order:</span>
    <span class="token class-name">OrderEntity</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>id <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>sequenceId <span class="token operator">=</span> sequenceId<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>direction <span class="token operator">=</span> direction<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>quantity <span class="token operator">=</span> quantity<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>unfilledQuantity <span class="token operator">=</span> quantity<span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> order<span class="token punctuation">.</span>updatedAt <span class="token operator">=</span> ts<span class="token punctuation">;</span>
    <span class="token comment">// 添加到ActiveOrders:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>activeOrders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加到UserOrders:</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> uOrders <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userOrders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uOrders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userOrders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> uOrders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    uOrders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>id<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="q-order的id和sequenceid为何不合并使用一个id"><a href="#q-order的id和sequenceid为何不合并使用一个id" class="header-anchor">#</a> Q：Order的id和sequenceId为何不合并使用一个ID？</h3> <p>订单ID是Order.id，是用户看到的订单标识，而Order.sequenceId是系统内部给订单的定序序列号，用于后续撮合时进入订单簿的排序，两者功能不同。</p> <p>可以使用一个简单的算法来根据Sequence ID计算Order ID：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>OrderID = SequenceID * 10000 + today(&quot;YYmm&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为SequenceID是全局唯一的，我们给SequenceID添加创建日期的&quot;YYmm&quot;部分，可轻松实现按月分库保存和查询。</p> <h2 id="_2-3-撮合引擎"><a href="#_2-3-撮合引擎" class="header-anchor">#</a> 2.3 撮合引擎</h2> <p>撮合引擎是交易系统的核心。本质上就是维护一个<strong>买卖盘</strong>列表，然后按价格优先原则对订单进行撮合，能够成交的就输出成交结果，不能成交的放入买卖盘。这里注意没有时间优先原则，因为经过定序的订单队列已经是一个时间优先的队列了。</p> <h3 id="订单薄orderbook"><a href="#订单薄orderbook" class="header-anchor">#</a> 订单薄OrderBook</h3> <p>用来表示买卖盘</p> <p>买盘排序：价格高在前，价格相同时间早在前</p> <p>卖盘排序：价格低在前，价格相同时间早在前</p> <p>首先考虑list，但插入删除效率低，因此用红黑树（TreeMap实现），以<strong>定序id</strong>比较时间</p> <blockquote><p>订单上虽然保存了创建时间，但排序时，是根据定序ID即<code>sequenceId</code>来排序，以确保全局唯一。时间本身实际上是订单的一个普通属性，仅展示给用户，不参与业务排序。</p></blockquote> <h3 id="撮合引擎matchengine"><a href="#撮合引擎matchengine" class="header-anchor">#</a> 撮合引擎MatchEngine</h3> <p>定义<code>MatchEngine</code>核心数据结构如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatchEngine</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">OrderBook</span> buyBook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderBook</span><span class="token punctuation">(</span><span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">BUY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 买盘</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">OrderBook</span> sellBook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderBook</span><span class="token punctuation">(</span><span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">SELL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 卖盘</span>
    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> marketPrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span> <span class="token comment">// 最新市场价</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> sequenceId<span class="token punctuation">;</span> <span class="token comment">// 上次处理的Sequence ID</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>一个完整的撮合引擎包含一个买盘、一个卖盘和一个最新成交价（初始值为0）。撮合引擎的输入是一个<code>OrderEntity</code>实例，每处理一个订单，就输出撮合结果<code>MatchResult</code>。</p> <p>对于撮合交易来说，如果新订单是一个买单，则首先尝试在卖盘中匹配价格合适的卖单，如果匹配成功则成交。</p> <blockquote><p>一个大的买单可能会匹配多个较小的卖单。当买单被完全匹配后，说明此买单已完全成交，处理结束，否则，如果存在<strong>未成交的</strong>买单，则将其放入买盘。处理卖单的逻辑是类似的。</p></blockquote> <p>已经挂在买卖盘的订单称为挂单（Maker），当前正在处理的订单称为吃单（Taker），一个Taker订单如果<strong>未完全成交</strong>则转为Maker挂在买卖盘。</p> <p>核心处理方法定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">MatchResult</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 买单与sellBook匹配，（如果还有剩）最后放入buyBook:</span>
        <span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token function">processOrder</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sellBook<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buyBook<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 卖单与buyBook匹配，（如果还有剩）最后放入sellBook:</span>
        <span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token function">processOrder</span><span class="token punctuation">(</span>sequenceId<span class="token punctuation">,</span> order<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buyBook<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sellBook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid direction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">MatchResult</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> takerOrder<span class="token punctuation">,</span> <span class="token class-name">OrderBook</span> makerBook<span class="token punctuation">,</span> <span class="token class-name">OrderBook</span> anotherBook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>撮合结果记录在<code>MatchResult</code>中，它可以用一个Taker订单和一系列撮合匹配记录表示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatchResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Order</span> takerOrder<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatchDetailRecord</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">MatchDetails</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造方法略</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>每一笔撮合记录则由成交双方、成交价格与数量表示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">MatchDetailRecord</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span> price<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> quantity<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> takerOrder<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> makerOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>根据价格匹配，直到成交双方有一方完全成交或成交条件不满足时结束处理，<code>processOrder()</code>的业务逻辑代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @param sequenceId 定序id
     * @param takerOrder  当前正在处理的订单
     * @param makerBook   尝试匹配成交的OrderBook（对手盘）
     * @param anotherBook 未能完全成交后挂单的OrderBook
     * @return 成交结果
     */</span>
<span class="token keyword">private</span> <span class="token class-name">MatchResult</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token keyword">long</span> sequenceId<span class="token punctuation">,</span> <span class="token class-name">OrderEntity</span> takerOrder<span class="token punctuation">,</span> <span class="token class-name">OrderBook</span> makerBook<span class="token punctuation">,</span>
                                 <span class="token class-name">OrderBook</span> anotherBook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceId <span class="token operator">=</span> sequenceId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> ts <span class="token operator">=</span> takerOrder<span class="token punctuation">.</span>createdAt<span class="token punctuation">;</span>
    <span class="token class-name">MatchResult</span> matchResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResult</span><span class="token punctuation">(</span>takerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> takerUnfilledQuantity <span class="token operator">=</span> takerOrder<span class="token punctuation">.</span>quantity<span class="token punctuation">;</span>
    <span class="token comment">// 一直循环，每次取maker（对手盘）第一个，目标是将taker完全匹配完</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> makerOrder <span class="token operator">=</span> makerBook<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>makerOrder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对手盘不存在:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>takerOrder<span class="token punctuation">.</span>direction <span class="token operator">==</span> <span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">BUY</span> <span class="token operator">&amp;&amp;</span> takerOrder<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 买入订单价格比卖盘第一档价格低:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>takerOrder<span class="token punctuation">.</span>direction <span class="token operator">==</span> <span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">SELL</span> <span class="token operator">&amp;&amp;</span> takerOrder<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 卖出订单价格比买盘第一档价格高:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 以Maker价格成交:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>marketPrice <span class="token operator">=</span> makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
        <span class="token comment">// 待成交数量为两者较小值:</span>
        <span class="token class-name">BigDecimal</span> matchedQuantity <span class="token operator">=</span> takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 成交记录:（价格、数量、maker</span>
        matchResult<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">.</span>price<span class="token punctuation">,</span> matchedQuantity<span class="token punctuation">,</span> makerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新成交后的订单数量:</span>
        <span class="token comment">// taker数量减去待成交数量</span>
        takerUnfilledQuantity <span class="token operator">=</span> takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>matchedQuantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> makerUnfilledQuantity <span class="token operator">=</span> makerOrder<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>matchedQuantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对手盘完全成交后，从订单簿中删除:</span>
        <span class="token comment">// 即看成交后的订单数是否为0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>makerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            makerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>makerUnfilledQuantity<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">FULLY_FILLED</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            makerBook<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>makerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对手盘部分成交:</span>
            makerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>makerUnfilledQuantity<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">PARTIAL_FILLED</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Taker订单完全成交后，退出循环:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            takerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">FULLY_FILLED</span><span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment">// end for</span>
    <span class="token comment">// Taker订单未完全成交时，放入买/卖订单簿:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        takerOrder<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>takerUnfilledQuantity<span class="token punctuation">,</span>
                               takerUnfilledQuantity<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>takerOrder<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>
                               <span class="token operator">:</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">PARTIAL_FILLED</span><span class="token punctuation">,</span>
                               ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        anotherBook<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>takerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> matchResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h2 id="_2-4-清算系统"><a href="#_2-4-清算系统" class="header-anchor">#</a> 2.4 清算系统</h2> <p>要把撮合结果最终实现为买卖双方的资产交换，就需要清算。清算系统就是处理撮合结果，将买卖双方冻结的USD和BTC分别交换到对方的可用余额，就使得买卖双方真正完成了资产交换。</p> <p>设计清算系统<code>ClearingService</code>，需要引用<code>AssetService</code>和<code>OrderService</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClearingService</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AssetService</span> assetService<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ClearingService</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">AssetService</span> assetService<span class="token punctuation">,</span> <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>assetService <span class="token operator">=</span> assetService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderService <span class="token operator">=</span> orderService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>撮合引擎输出<code>MatchResult</code>后，<code>ClearingService</code>需要处理该结果，，该清算方法代码框架如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearMatchResult</span><span class="token punctuation">(</span><span class="token class-name">MatchResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> taker <span class="token operator">=</span> result<span class="token punctuation">.</span>takerOrder<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>direction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid direction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="买入"><a href="#买入" class="header-anchor">#</a> 买入</h3> <p>买家冻结的USD转入卖方账户，卖方冻结的BTC转入买方账户。</p> <blockquote><p>对Taker买入成交的订单，处理时需要注意，成交价格是按照Maker的报价成交的，而Taker冻结的金额是按照Taker订单的报价冻结的，因此，解冻后，部分差额要退回至Taker可用余额</p> <p>交易资产在哪冻结的？创建订单时。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token constant">BUY</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 买入时，按Maker的价格成交：</span>
    <span class="token comment">// 遍历撮合结果的所有匹配记录（taker对应的所有maker）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MatchDetailRecord</span> detail <span class="token operator">:</span> result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从匹配记录中读卖家挂单</span>
        <span class="token class-name">OrderEntity</span> maker <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">makerOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 数量</span>
        <span class="token class-name">BigDecimal</span> matched <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">quantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/** 【注意】：对Taker买入成交的订单，成交价格是按照Maker的报价成交的，而Taker冻结的金额是按照Taker订单的报价冻结的
                     因此，解冻后，部分差额要退回至Taker可用余额
                 **/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 实际买入价比报价低，部分USD退回账户:</span>
            <span class="token class-name">BigDecimal</span> unfreezeQuote <span class="token operator">=</span> taker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;unfree extra unused quote {} back to taker user {}&quot;</span><span class="token punctuation">,</span> unfreezeQuote<span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            assetService<span class="token punctuation">.</span><span class="token function">unfreeze</span><span class="token punctuation">(</span>taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span> unfreezeQuote<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 买家出USD，换卖家的BTC</span>
        <span class="token comment">// 买方USD转入卖方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span>
                              maker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 卖方BTC转入买方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">BTC</span><span class="token punctuation">,</span> matched<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除完全成交的Maker:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除完全成交的Taker:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>taker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="卖出"><a href="#卖出" class="header-anchor">#</a> 卖出</h3> <p><strong>卖家出BTC，换买家的USD</strong></p> <p>对Taker卖出成交的订单，只需将冻结的BTC转入Maker，将Maker冻结的USD转入Taker即可：</p> <blockquote><p>这里不用考虑差价，因为设计下单时，卖单冻结的是BTC，换成USD直接按挂单价换算即可。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token constant">SELL</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// taker是卖单，以maker的价格成交</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MatchDetailRecord</span> detail <span class="token operator">:</span> result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// maker是买家挂单</span>
        <span class="token class-name">OrderEntity</span> maker <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">makerOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> matched <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">quantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 卖家出BTC，换买家的USD</span>
        <span class="token comment">/**【注意】这里不用考虑差价，因为taker是卖单时，以买单的maker.price成交。
                    设计下单时，卖单冻结的是BTC，换成USD直接按挂单价maker.price换算即可。
                    并不关心taker.price
                    前面买单考虑差价是因为冻结的是USD，最终交易的也是USD，即taker.price与maker.price存在差价
                 **/</span>
        <span class="token comment">// 卖方BTC转入买方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">BTC</span><span class="token punctuation">,</span> matched<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 买方USD转入卖方账户:</span>
        assetService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span><span class="token punctuation">.</span><span class="token constant">FROZEN_TO_AVAILABLE</span><span class="token punctuation">,</span> maker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> taker<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">AssetEnum</span><span class="token punctuation">.</span><span class="token constant">USD</span><span class="token punctuation">,</span>
                              maker<span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除完全成交的Maker:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>maker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除完全成交的Taker:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taker<span class="token punctuation">.</span>unfilledQuantity<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        orderService<span class="token punctuation">.</span><span class="token function">removeOrder</span><span class="token punctuation">(</span>taker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="_2-5-完成交易引擎"><a href="#_2-5-完成交易引擎" class="header-anchor">#</a> 2.5 完成交易引擎</h2> <p>把上述模块整合，实现一个完整的交易引擎：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TradingEngineService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AssetService</span> assetService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MatchEngine</span> matchEngine<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ClearingService</span> clearingService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="整合定序系统"><a href="#整合定序系统" class="header-anchor">#</a> 整合定序系统</h3> <p>交易引擎由事件驱动，因此，通过订阅Kafka的Topic实现批量读消息，然后依次处理每个事件。由于【定序系统】的作用，消息的sequenceId应该<strong>严格递增</strong>，考虑消息重复和消息丢失两种情况：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">processMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processEvent</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重复消息，丢弃</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>sequenceId <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;skip duplicate event: {}&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    <span class="token comment">// 丢失了消息，从数据库读取恢复</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>previousId <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractEvent</span><span class="token punctuation">&gt;</span></span> events <span class="token operator">=</span> storeService<span class="token punctuation">.</span><span class="token function">loadEventsFromDb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastSequenceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 读取失败</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> e <span class="token operator">:</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 处理丢失的消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断当前消息是否指向上一条消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>previousId <span class="token operator">!=</span> lastSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不满足说明【系统异常】，退出</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">OrderRequestEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderRequestEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">OrderCancelEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderCancelEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">TransferEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TransferEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>这样，对消息系统的依赖就不是要求它100%可靠，遇到重复消息、丢失消息，交易引擎都可以从这些错误中自己恢复。</p> <p>目前一共有3种类型的事件：创建订单、取消订单、转账，处理都非常简单。以<code>createOrder()</code>为例，核心代码很少：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderRequestEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生成Order ID:</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> event<span class="token punctuation">.</span>sequenceId <span class="token operator">*</span> <span class="token number">10000</span> <span class="token operator">+</span> <span class="token punctuation">(</span>year <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> month<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建Order:</span>
    <span class="token class-name">OrderEntity</span> order <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>sequenceId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>createdAt<span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> event<span class="token punctuation">.</span>price<span class="token punctuation">,</span> event<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;create order failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 撮合:</span>
    <span class="token class-name">MatchResult</span> result <span class="token operator">=</span> matchEngine<span class="token punctuation">.</span><span class="token function">processOrder</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>sequenceId<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清算:</span>
    clearingService<span class="token punctuation">.</span><span class="token function">clearMatchResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="异步处理"><a href="#异步处理" class="header-anchor">#</a> 异步处理</h3> <p>核心的业务逻辑并不复杂，只是交易引擎在处理完订单后，仅仅改变自身状态是不够的，它还得向外输出具体的成交信息、订单状态等。</p> <p>因此，需要根据业务需求，在清算后继续收集撮合结果、已完成订单、准备发送的通知等，通过消息系统或Redis向外输出交易信息。</p> <p>如果把这些功能放到同一个线程内同步完成是非常耗时的，更好的方法是把它们先存储起来，再<strong>异步处理</strong>。</p> <p>例如，对于已完成的订单，可以异步落库：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> orderQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderRequestEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 清算完成后,收集已完成Order:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> closedOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>takerOrder<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isFinalStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            closedOrders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>takerOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MatchDetailRecord</span> detail <span class="token operator">:</span> result<span class="token punctuation">.</span>matchDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">OrderEntity</span> maker <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">makerOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maker<span class="token punctuation">.</span>status<span class="token punctuation">.</span>isFinalStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                closedOrders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>maker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>closedOrders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 启动一个线程将orderQueue的Order异步写入数据库:</span>
<span class="token keyword">void</span> <span class="token function">saveOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO:</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>类似的，输出OrderBook、通知用户成交等信息都是异步处理。</p> <h3 id="验证模块"><a href="#验证模块" class="header-anchor">#</a> 验证模块</h3> <p>由于资产、订单、撮合、清算都在内存中完成，如何保证交易引擎每处理一个事件，它的内部状态都是正确的呢？我们可以为交易引擎增加一个自验证功能，在debug模式下，每处理一个事件，就自动验证内部状态的完整性，包括：</p> <ul><li>验证资产系统总额为0，且除负债账户外其余账户资产不为负；</li> <li>验证订单系统未成交订单所冻结的资产与资产系统中的冻结一致；</li> <li>验证订单系统的订单与撮合引擎的订单簿一对一存在。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token class-name">AbstractEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>debugMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;start validate...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateMatchEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;validate ok.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这样我们就能快速在开发阶段尽可能早地发现问题。</p> <h3 id="q-交易引擎崩溃后如何恢复"><a href="#q-交易引擎崩溃后如何恢复" class="header-anchor">#</a> Q：交易引擎崩溃后如何恢复？</h3> <p>交易引擎如果运行时崩溃，可以重启，然后把现有的<strong>所有交易事件重头开始执行一遍</strong>，即可得到最新的状态。</p> <p>注意到重头开始执行交易事件，会导致重复发出市场成交、用户订单通知等事件，因此，可根据时间做判断，不再重复发通知。下游系统在处理通知事件时，也要根据通知携带的<code>sequenceId</code>做去重判断。</p> <h3 id="q-如果现有的交易事件太多-恢复需要花费几天-怎么办"><a href="#q-如果现有的交易事件太多-恢复需要花费几天-怎么办" class="header-anchor">#</a> Q：如果现有的交易事件太多，恢复需要花费几天，怎么办？</h3> <p>可以定期把交易引擎的<strong>状态序列化</strong>至文件系统，例如，每10分钟一次。当交易引擎崩溃时，读取最新的状态文件，即可恢复至约10分钟前的状态，后续追赶只需要执行很少的事件消息。</p> <p>交易引擎的状态包括：</p> <ul><li>资产系统的状态：即所有用户的资产列表；</li> <li>订单系统的状态：即所有活动订单列表；</li> <li>撮合引擎的状态：即买卖盘和最新市场价；</li> <li>最后一次处理的sequenceId。</li></ul> <p>序列化时，分别针对每个子系统进行序列化。对资产系统来说，每个用户的资产可序列化为<code>用户ID: [USD可用, USD冻结, BTC可用, BTC冻结]</code>的JSON格式，整个资产系统序列化后结构如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;1&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-123000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">-12.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;100&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">60000</span><span class="token punctuation">,</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;200&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">43000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>订单系统可序列化为一系列活动订单列表：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">10012207</span><span class="token punctuation">,</span> <span class="token property">&quot;sequenceId&quot;</span><span class="token operator">:</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">20901</span><span class="token punctuation">,</span> ...<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">10022207</span><span class="token punctuation">,</span> <span class="token property">&quot;sequenceId&quot;</span><span class="token operator">:</span> <span class="token number">1002</span><span class="token punctuation">,</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">20902</span><span class="token punctuation">,</span> ...<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>撮合引擎可序列化为买卖盘列表（仅包含订单ID）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;BUY&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10012207</span><span class="token punctuation">,</span> <span class="token number">10022207</span><span class="token punctuation">,</span> ...<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;SELL&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;marketPrice&quot;</span><span class="token operator">:</span> <span class="token number">20901</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后合并为一个交易引擎的状态文件：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;sequenceId&quot;</span><span class="token operator">:</span> <span class="token number">189000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;orders&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>交易引擎启动时，读取状态文件，然后依次恢复资产系统、订单系统和撮合引擎的状态，就得到了指定<code>sequenceId</code>的状态。</p> <p>写入状态时，如果是异步写入，需要先复制状态、再写入，防止多线程读同一实例导致状态不一致。读写JSON时，要使用JSON库的流式API（例如Jackson的Streaming API），以免内存溢出。对<code>BigDecimal</code>进行序列化时，要注意不要误读为<code>double</code>类型以免丢失精度。</p> <h1 id="_3-api系统"><a href="#_3-api系统" class="header-anchor">#</a> 3.API系统</h1> <p>有了交易引擎和定序系统，还需一个API系统，用于接收所有交易员的订单请求。相比事件驱动的交易引擎，API系统就比较简单，因为它就是一个标准的Web应用。</p> <p>在编写API之前，需要对请求进行认证，即识别出是哪个用户发出的请求。用户认证放在Filter中最合适。认证方式可以是简单粗暴的用户名+口令，也可以是Token，也可以是API Key+API Secret等模式。</p> <p>先实现一个最简单的用户名+口令的认证方式。需要注意的是，API和Web页面不同，Web页面可以给用户一个登录页，登录成功后设置Session或Cookie，后续请求检查的是Session或Cookie。API不能使用Session，因为Session很难做无状态集群，API也不建议使用Cookie，因为API域名很可能与Web UI的域名不一致，拿不到Cookie。要在API中使用用户名+口令的认证方式，可以用标准的HTTP头<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Authorization" target="_blank" rel="noopener noreferrer">Authorization<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<code>Basic</code>模式：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Authorization: Basic 用户名:口令
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>尝试从<code>Authorization</code>中获取用户名和口令来认证：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Long</span> <span class="token function">parseUserFromAuthorization</span><span class="token punctuation">(</span><span class="token class-name">String</span> auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;Basic &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用Base64解码:</span>
        <span class="token class-name">String</span> eap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 分离email:password</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> eap<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> email <span class="token operator">=</span> eap<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> passwd <span class="token operator">=</span> eap<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 验证:</span>
        <span class="token class-name">UserProfileEntity</span> p <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">signin</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> passwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApiException</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">.</span><span class="token constant">AUTH_SIGNIN_FAILED</span><span class="token punctuation">,</span> <span class="token string">&quot;Invalid Authorization header.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在<code>ApiFilter</code>中完成认证后，使用<code>UserContext</code>传递用户ID，：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiFilter</span>  <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> resp<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 尝试认证用户:</span>
        <span class="token class-name">String</span> authHeader <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> authHeader <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">parseUserFromAuthorization</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 匿名身份:</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用户身份:</span>
            <span class="token comment">// ************* ctx未直接使用，仅用来通过ThreadLocal传递用户ID *****************</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">UserContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserContext</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>注意</strong>：ApiFilter中创建了UserContext却没使用，是因为将用户ID保存在ThreadLocal，通过线程上下文传递</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserContext</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">THREAD_LOCAL_CTX</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Basic模式很简单，需要注意的是<code>用户名:口令</code>使用<code>:</code>分隔，然后整个串用Base64编码，因此，读取的时候需要先用Base64解码。</p> <p>虽然Basic模式并不安全，但是有了一种基本的认证模式，我们就可以把API-定序-交易串起来了。后续我们再继续添加其他认证模式。</p> <h2 id="编写api-controller"><a href="#编写api-controller" class="header-anchor">#</a> 编写API Controller</h2> <p>对于认证用户的操作，例如，查询资产余额，可通过<code>UserContext</code>获取当前用户，然后通过交易引擎查询并返回用户资产余额：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/assets&quot;</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getRequiredUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tradingEngineApiProxyService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/internal/&quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;/assets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>因为交易引擎返回的结果就是JSON字符串，没必要先反序列化再序列化，可以以<code>String</code>的方式直接返回给客户端，需要标注<code>@ResponseBody</code>表示不要对<code>String</code>再进行序列化处理。</p> <p>对于无需认证的操作，例如，查询公开市场的订单簿，可以直接返回Redis缓存结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/orderBook&quot;</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOrderBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">ORDER_BOOK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">OrderBookBean</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span> <span class="token operator">:</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>但是对于创建订单的请求，处理就麻烦一些，因为API收到请求后，仅仅通过消息系统给定序系统发了一条消息。消息系统本身并不是类似HTTP的请求-响应模式，我们拿不到消息处理的结果。这里先借助Spring的异步响应模型<code>DeferredResult</code>，再借助Redis的pub/sub模型，当API发送消息时，使用全局唯一<code>refId</code>跟踪消息，当交易引擎处理完订单请求后，向Redis发送pub事件，API收到Redis推送的事件后，根据<code>refId</code>找到<code>DeferredResult</code>，设置结果后由Spring异步返回给客户端：</p> <div class="language-ascii line-numbers-mode"><pre class="language-text"><code>   ┌─────────┐                 ┌─────────┐
──&gt;│   API   │&lt;────────────────│  Redis  │
   └─────────┘                 └─────────┘
        │                           ▲
        ▼                           │
   ┌─────────┐                      │
   │   MQ    │                   pub│
   └─────────┘                      │
        │                           │
        ▼                           │
   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │Sequencer│──&gt;│   MQ    │──&gt;│ Engine  │
   └─────────┘   └─────────┘   └─────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>代码实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TradingApiController</span> <span class="token punctuation">{</span>
    <span class="token comment">// 消息refId -&gt; DeferredResult:</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DeferredResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> deferredResultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedisService</span> redisService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 订阅Redis:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">RedisCache<span class="token punctuation">.</span>Topic</span><span class="token punctuation">.</span><span class="token constant">TRADING_API_RESULT</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">onApiResultMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/orders&quot;</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">OrderRequestBean</span> orderRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getRequiredUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息的Reference ID:</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> refId <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">generateUniqueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderRequestEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>refId <span class="token operator">=</span> refId<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>direction <span class="token operator">=</span> orderRequest<span class="token punctuation">.</span>direction<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>price <span class="token operator">=</span> orderRequest<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>quantity <span class="token operator">=</span> orderRequest<span class="token punctuation">.</span>quantity<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果超时则返回:</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> timeout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">getTimeoutJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 正常异步返回:</span>
        <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> deferred <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.5秒超时</span>
        deferred<span class="token punctuation">.</span><span class="token function">onTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>deferredResultMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>refId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据refId跟踪消息处理结果:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deferredResultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>refId<span class="token punctuation">,</span> deferred<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息:</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> deferred<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 收到Redis的消息结果推送:</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApiResultMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApiResultMessage</span> message <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">ApiResultMessage</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>refId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 根据消息refId查找DeferredResult:</span>
            <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> deferred <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deferredResultMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>refId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deferred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 找到DeferredResult后设置响应结果:</span>
                <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">writeJson</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                deferred<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h2 id="如何实现api-key认证"><a href="#如何实现api-key认证" class="header-anchor">#</a> 如何实现API Key认证</h2> <p>添加一个<code>api_auths</code>表，存储API Key、API Secret并关联至某个用户ID：</p> <table><thead><tr><th style="text-align:left;">userId</th> <th style="text-align:left;">apiKey</th> <th style="text-align:left;">apiSecret</th></tr></thead> <tbody><tr><td style="text-align:left;">101</td> <td style="text-align:left;">5b503947f4f5d34a</td> <td style="text-align:left;">e57c677d4ab4c5a4</td></tr> <tr><td style="text-align:left;">102</td> <td style="text-align:left;">13a867e8da13c7f6</td> <td style="text-align:left;">92e41573e833ae13</td></tr> <tr><td style="text-align:left;">102</td> <td style="text-align:left;">341a8e60baf5b824</td> <td style="text-align:left;">302c9e195826267f</td></tr></tbody></table> <p>用户使用API Key认证时，提供API Key，以及用API Secret计算的Hmac哈希，服务器验证Hmac哈希后，就可以确认用户身份，因为其他人不知道该用户的API Secret，无法计算出正确的Hmac。</p> <p>发送API Key认证时，可以定义如下的HTTP头：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>API-Key: 5b503947f4f5d34a
API-Timestamp: 20220726T092137Z &lt;- 防止重放攻击的时间戳
API-Signature: d7a567b6cab85bcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>计算签名的原始输入可以包括HTTP Method、Path、Timestamp、Body等关键信息，具体格式可参考<a href="https://docs.aws.amazon.com/zh_cn/general/latest/gr/signature-version-4.html" target="_blank" rel="noopener noreferrer">AWS API签名方式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>一个用户可以关联多个API Key认证，还可以给每个API Key附加特定权限，例如只读权限，这样用API Key认证就更加安全。</p> <h3 id="内部系统调用api如何实现用户认证"><a href="#内部系统调用api如何实现用户认证" class="header-anchor">#</a> 内部系统调用API如何实现用户认证</h3> <p>很多时候，内部系统也需要调用API，并且需要以特定用户的身份调用API。让内部系统去读用户的口令或者API Key都是不合理的，更好的方式是使用一次性Token，还是利用Authorization头的Bearer模式：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Authorization: Bearer 5NPtI6LW...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>构造一次性Token可以用<code>userId:expires:hmac</code>，内部系统和API共享同一个Hmac Key，就可以正确计算并验证签名。外部用户因为无法获得Hmac Key而无法伪造Token。</p> <h3 id="如何跟踪api性能"><a href="#如何跟踪api性能" class="header-anchor">#</a> 如何跟踪API性能</h3> <p>可以使用Spring提供的<code>HandlerInterceptor</code>和<code>DeferredResultProcessingInterceptor</code>跟踪API性能，它们分别用于拦截同步API和异步API。</p> <h1 id="_4-行情系统"><a href="#_4-行情系统" class="header-anchor">#</a> 4.行情系统</h1> <p>行情系统用来生成公开市场的历史数据，主要是<strong>K线图</strong>。需要按1秒、1分钟、1小时和1天来生成不同类型的K线，因此，行情系统的功能就是不断从消息系统中读取Tick，合并，然后输出不同类型的K线。</p> <blockquote><p>K线图的数据来源是交易引擎成交产生的一个个Tick。一个K线包括OHLC这4个价格数据。在一个时间段内，第一个Tick的价格是Open，最后一个Tick的价格是Close，最高的价格是High，最低的价格是Low：</p></blockquote> <div class="language-ascii line-numbers-mode"><pre class="language-text"><code>     High -&gt; │
             │
           ┌─┴─┐&lt;─ Close
           │   │
   Open -&gt; └─┬─┘
             │
      Low -&gt; │
   ```


给定一组Tick集合，就可以汇总成一个K线，对应一个Bar结构：


```java
public class AbstractBarEntity {
  public long startTime; // 开始时间
  public BigDecimal openPrice; // 开始价格
  public BigDecimal highPrice; // 最高价格
  public BigDecimal lowPrice; // 最低价格
  public BigDecimal closePrice; // 结束价格
  public BigDecimal quantity; // 成交数量
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>行情系统是典型的<strong>读多写少</strong>模式，非常适合缓存，因此最近的成交信息和K线图，缓存在<strong>Redis</strong>中，对于较早的K线图，通过<strong>数据库</strong>查询。因此，行情系统需要将生成的K线保存到数据库中，同时负责不断更新Redis的缓存。</p> <h2 id="缓存redis"><a href="#缓存redis" class="header-anchor">#</a> 缓存redis</h2> <p>对于最新成交信息，在Redis中用一个<strong>List</strong>表示，它的每一个元素是一个序列号后的JSON：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[&quot;{...}&quot;, &quot;{...}&quot;, &quot;{...}&quot;...]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果有新的Tick产生，就需要把它们追加到列表尾部，同时将最早的Tick删除，以便维护一个<strong>最近成交的列表</strong>（100条）。</p> <p><strong>Lua脚本</strong></p> <p>直接读取Redis列表，操作后再写回Redis是可以的，但比较麻烦。这里我们直接用<strong>Lua脚本</strong>更新最新Tick列表。</p> <blockquote><p>Redis支持将一个Lua脚本加载后，直接在Redis内部执行脚本</p></blockquote> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token keyword">local</span> KEY_LAST_SEQ <span class="token operator">=</span> <span class="token string">'_TickSeq_'</span> <span class="token comment">-- 上次更新的SequenceID</span>
<span class="token keyword">local</span> LIST_RECENT_TICKS <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">-- 最新Ticks的Key</span>

<span class="token keyword">local</span> seqId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">-- 输入的SequenceID</span>
<span class="token keyword">local</span> jsonData <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">-- 输入的JSON字符串表示的tick数组：&quot;[&quot;{...}&quot;,&quot;{...}&quot;,...]&quot;</span>
<span class="token keyword">local</span> strData <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">-- 输入的JSON字符串表示的tick数组：&quot;[{...},{...},...]&quot;</span>

<span class="token comment">-- 获取上次更新的sequenceId:</span>
<span class="token keyword">local</span> lastSeqId <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> KEY_LAST_SEQ<span class="token punctuation">)</span>
<span class="token keyword">local</span> ticks<span class="token punctuation">,</span> len<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> lastSeqId <span class="token keyword">or</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>seqId<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>lastSeqId<span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 广播:</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'PUBLISH'</span><span class="token punctuation">,</span> <span class="token string">'notification'</span><span class="token punctuation">,</span> <span class="token string">'{&quot;type&quot;:&quot;tick&quot;,&quot;sequenceId&quot;:'</span> <span class="token operator">..</span> seqId <span class="token operator">..</span> <span class="token string">',&quot;data&quot;:'</span> <span class="token operator">..</span> jsonData <span class="token operator">..</span> <span class="token string">'}'</span><span class="token punctuation">)</span>
    <span class="token comment">-- 保存当前sequence id:</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'SET'</span><span class="token punctuation">,</span> KEY_LAST_SEQ<span class="token punctuation">,</span> seqId<span class="token punctuation">)</span>
    <span class="token comment">-- 更新最新tick列表:</span>
    ticks <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>strData<span class="token punctuation">)</span>
    len <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'RPUSH'</span><span class="token punctuation">,</span> LIST_RECENT_TICKS<span class="token punctuation">,</span> <span class="token function">unpack</span><span class="token punctuation">(</span>ticks<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> len <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token keyword">then</span>
        <span class="token comment">-- 裁剪LIST以保存最新的100个Tick:</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'LTRIM'</span><span class="token punctuation">,</span> LIST_RECENT_TICKS<span class="token punctuation">,</span> len<span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>
<span class="token comment">-- 无更新返回false</span>
<span class="token keyword">return</span> <span class="token keyword">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在API中，要获取最新成交信息，直接从Redis缓存取出列表，然后拼接成一个JSON字符串：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/ticks&quot;</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRecentTicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">RECENT_TICKS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> data<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;[]&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">StringJoiner</span> sj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> t <span class="token operator">:</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sj<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>用Lua脚本还有一个好处，就是执行时不但可以更新List，还可以通过<strong>Publish</strong>命令广播事件，后续我们编写基于WebSocket的推送服务器时，直接监听Redis广播，就可以主动向浏览器推送Tick更新的事件。</p> <p>类似的，针对每一种K线，我们都在Redis中用ZSet存储，用K线的开始时间戳作为Score。更新K线时，从每种ZSet中找出Score最大的Bar结构，就是最后一个Bar，然后尝试更新。如果可以持久化这个Bar就返回，如果可以合并这个Bar就刷新ZSet，用Lua脚本实现如下：</p> <p>common/src/main/resources/redis/update-bar.lua</p> <h2 id="编写quotationservice"><a href="#编写quotationservice" class="header-anchor">#</a> 编写QuotationService</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuotationService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedisService</span> redisService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MessagingFactory</span> messagingFactory<span class="token punctuation">;</span>

    <span class="token class-name">MessageConsumer</span> tickConsumer<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> shaUpdateRecentTicksLua <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> shaUpdateBarLua <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加载Redis脚本:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shaUpdateRecentTicksLua <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token function">loadScriptFromClassPath</span><span class="token punctuation">(</span><span class="token string">&quot;/redis/update-recent-ticks.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shaUpdateBarLua <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisService<span class="token punctuation">.</span><span class="token function">loadScriptFromClassPath</span><span class="token punctuation">(</span><span class="token string">&quot;/redis/update-bar.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 接收Tick消息:</span>
        <span class="token class-name">String</span> groupId <span class="token operator">=</span> <span class="token class-name">Messaging<span class="token punctuation">.</span>Topic</span><span class="token punctuation">.</span><span class="token constant">TICK</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">getHostId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tickConsumer <span class="token operator">=</span> messagingFactory<span class="token punctuation">.</span><span class="token function">createBatchMessageListener</span><span class="token punctuation">(</span><span class="token class-name">Messaging<span class="token punctuation">.</span>Topic</span><span class="token punctuation">.</span><span class="token constant">TICK</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">processMessages</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理接收的消息:</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractMessage</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TickMessage</span><span class="token punctuation">)</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理一个Tick消息:</span>
    <span class="token keyword">void</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">TickMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对一个Tick消息中的多个Tick先进行合并:</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> createdAt <span class="token operator">=</span> message<span class="token punctuation">.</span>createdAt<span class="token punctuation">;</span>
        <span class="token class-name">StringJoiner</span> ticksStrJoiner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringJoiner</span> ticksJoiner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> openPrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> closePrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> highPrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> lowPrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> quantity <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TickEntity</span> tick <span class="token operator">:</span> message<span class="token punctuation">.</span>ticks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> tick<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ticksStrJoiner<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot;&quot;</span> <span class="token operator">+</span> json <span class="token operator">+</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ticksJoiner<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>openPrice<span class="token punctuation">.</span><span class="token function">signum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                openPrice <span class="token operator">=</span> tick<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                closePrice <span class="token operator">=</span> tick<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                highPrice <span class="token operator">=</span> tick<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                lowPrice <span class="token operator">=</span> tick<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// open price is set:</span>
                closePrice <span class="token operator">=</span> tick<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                highPrice <span class="token operator">=</span> highPrice<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
                lowPrice <span class="token operator">=</span> lowPrice<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            quantity <span class="token operator">=</span> quantity<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 计算应该合并的每种类型的Bar的开始时间:</span>
        <span class="token keyword">long</span> sec <span class="token operator">=</span> createdAt <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> min <span class="token operator">=</span> sec <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> hour <span class="token operator">=</span> min <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> secStartTime <span class="token operator">=</span> sec <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> minStartTime <span class="token operator">=</span> min <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> hourStartTime <span class="token operator">=</span> hour <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> dayStartTime <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochMilli</span><span class="token punctuation">(</span>hourStartTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span>zoneId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withHour</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token comment">// ******************** k线数据准备完毕 ***************************</span>
        <span class="token comment">// 1、更新Redis最近的Ticks缓存:</span>
        <span class="token comment">// 更新Tick缓存:</span>
        <span class="token class-name">String</span> ticksData <span class="token operator">=</span> ticksJoiner<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> tickOk <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">executeScriptReturnBoolean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shaUpdateRecentTicksLua<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">RECENT_TICKS</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sequenceId<span class="token punctuation">)</span><span class="token punctuation">,</span> ticksData<span class="token punctuation">,</span> ticksStrJoiner<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickOk<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;ticks are ignored by Redis.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         <span class="token comment">// 2、保存Tick至数据库:</span>
        <span class="token function">saveTicks</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3、更新redis各种类型的K线:</span>
        <span class="token class-name">String</span> strCreatedBars <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">executeScriptReturnString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shaUpdateBarLua<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">SEC_BARS</span><span class="token punctuation">,</span> <span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">MIN_BARS</span><span class="token punctuation">,</span> <span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">HOUR_BARS</span><span class="token punctuation">,</span>
                        <span class="token class-name">RedisCache<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token constant">DAY_BARS</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token comment">// ARGV</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sequenceId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// sequence id</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>secStartTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// sec-start-time</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>minStartTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// min-start-time</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>hourStartTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// hour-start-time</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dayStartTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// day-start-time</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>openPrice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// open</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>highPrice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// high</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>lowPrice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// low</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>closePrice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// close</span>
                        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token comment">// quantity</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">BarType</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> barMap <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">readJson</span><span class="token punctuation">(</span>strCreatedBars<span class="token punctuation">,</span> <span class="token constant">TYPE_BARS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>barMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 保存Bar:</span>
            <span class="token class-name">SecBarEntity</span> secBar <span class="token operator">=</span> <span class="token function">createBar</span><span class="token punctuation">(</span><span class="token class-name">SecBarEntity</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> barMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BarType</span><span class="token punctuation">.</span><span class="token constant">SEC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MinBarEntity</span> minBar <span class="token operator">=</span> <span class="token function">createBar</span><span class="token punctuation">(</span><span class="token class-name">MinBarEntity</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> barMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BarType</span><span class="token punctuation">.</span><span class="token constant">MIN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HourBarEntity</span> hourBar <span class="token operator">=</span> <span class="token function">createBar</span><span class="token punctuation">(</span><span class="token class-name">HourBarEntity</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> barMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BarType</span><span class="token punctuation">.</span><span class="token constant">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DayBarEntity</span> dayBar <span class="token operator">=</span> <span class="token function">createBar</span><span class="token punctuation">(</span><span class="token class-name">DayBarEntity</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> barMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BarType</span><span class="token punctuation">.</span><span class="token constant">DAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">saveBars</span><span class="token punctuation">(</span>secBar<span class="token punctuation">,</span> minBar<span class="token punctuation">,</span> hourBar<span class="token punctuation">,</span> dayBar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><p>K线是一组Bar按ZSet缓存在Redis中，Score就是Bar的开始时间。更新Bar时，同时广播通知，以便后续推送。要查询某种K线图，在API中，需要传入开始和结束的时间戳，通过ZRANGE命令返回排序后的List：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getBars</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// k线以时间为score排序，取时间在[start, end]之间的数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">zrangebyscore</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> data<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;[]&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">StringJoiner</span> sj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> t <span class="token operator">:</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sj<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h1 id="_5-推送系统"><a href="#_5-推送系统" class="header-anchor">#</a> 5.推送系统</h1> <p>推送系统负责将公开市场的实时信息，包括订单簿、最新成交、最新K线等推送给客户端，对于用户的订单，还需要将成交信息推送给指定用户。</p> <p>和普通Web应用不同的是，基于Servlet的线程池模型不能高效地支持成百上千的WebSocket长连接。Java提供了NIO能充分利用Linux系统的epoll机制高效支持大量的长连接，但是直接使用NIO的接口非常繁琐，通常我们会选择基于NIO的<a href="https://netty.io/" target="_blank" rel="noopener noreferrer">Netty<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>服务器。直接使用Netty其实仍然比较繁琐，基于Netty开发我们可以选择：</p> <ul><li>Spring WebFlux：封装了Netty并实现Reactive接口；</li> <li>Vert.x：封装了Netty并提供简单的API接口。</li></ul> <p>这里我们选择<a href="https://vertx.io/" target="_blank" rel="noopener noreferrer">Vert.x<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，因为它的API更简单。</p> <p>启动类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">// 禁用数据库自动配置 (无DataSource, JdbcTemplate...)</span>
<span class="token annotation punctuation">@EnableAutoConfiguration</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PushApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;vertx.disableFileCPResolving&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;vertx.logger-delegate-factory-class-name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;io.vertx.core.logging.SLF4JLogDelegateFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SpringApplication</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">PushApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 禁用Spring的Web:</span>
        app<span class="token punctuation">.</span><span class="token function">setWebApplicationType</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>由于需要利用Spring Cloud Config读取配置，所以推送系统仍然是标准springboot应用。由于不使用Spring自身的Web功能，因此需要禁用Spring的Web功能。推送服务本身并不需要访问数据库，因此禁用数据库自动配置。最后，把<code>PushApplication</code>放在<code>com.itranswarp.exchange.push</code>包下面，以避免自动扫描到<code>com.itranswarp.exchange</code>包下的组件（如RedisService）。</p> <h2 id="pushservice"><a href="#pushservice" class="header-anchor">#</a> PushService</h2> <p>然后编写<code>PushService</code>，注意它是一个Spring组件，由Spring初始化，目的是注入各种配置。在初始化方法中，就可以启动Vert.x：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startVertx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 启动Vert.x:</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertx <span class="token operator">=</span> <span class="token class-name">Vertx</span><span class="token punctuation">.</span><span class="token function">vertx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个Vert.x Verticle组件:</span>
    <span class="token keyword">var</span> push <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PushVerticle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hmacKey<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vertx<span class="token punctuation">.</span><span class="token function">deployVerticle</span><span class="token punctuation">(</span>push<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 连接到Redis:</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisPassword<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisPassword <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisHost
            <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisPort <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisDatabase<span class="token punctuation">;</span>
    <span class="token class-name">Redis</span> redis <span class="token operator">=</span> <span class="token class-name">Redis</span><span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span>vertx<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    redis<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>conn <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 事件处理:</span>
        conn<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>response <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 收到Redis的PUSH:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseType</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> size <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Response</span> type <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token keyword">instanceof</span> <span class="token class-name">BulkType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 收到PUBLISH通知:</span>
                        <span class="token class-name">String</span> msg <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 由push verticle组件处理该通知:</span>
                        push<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅Redis的Topic:</span>
        conn<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">.</span><span class="token function">cmd</span><span class="token punctuation">(</span><span class="token class-name">Command</span><span class="token punctuation">.</span><span class="token constant">SUBSCRIBE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token class-name">RedisCache<span class="token punctuation">.</span>Topic</span><span class="token punctuation">.</span><span class="token constant">NOTIFICATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>resp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;subscribe ok.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;subscribe failed.&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;connect to redis failed.&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h2 id="pushverticle"><a href="#pushverticle" class="header-anchor">#</a> PushVerticle</h2> <p>Vert.x用<code>Verticle</code>表示一个组件，编写<code>PushVerticle</code>来处理所有WebSocket连接，重写其<code>start()</code>方法，由Vert.x回调。<code>start()</code>方法主要逻辑：</p> <ol><li>创建基于Vert.x的HTTP服务器（内部使用Netty）；</li> <li>创建路由；</li> <li>绑定一个路径为<code>/notification</code>的GET请求，将其<strong>升级为WebSocket</strong>连接；</li> <li>绑定其他路径的GET请求；</li> <li>开始监听指定端口号。</li></ol> <p>在Vert.x中，每个WebSocket连接都有一个唯一的Handler标识，以<code>String</code>表示。用几个<code>Map</code>保存Handler和用户ID的映射关系，当关闭连接时，将对应的映射关系删除。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 所有Handler:</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> handlersSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 用户ID -&gt; Handlers</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> userToHandlersMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Handler -&gt; 用户ID</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> handlerToUserMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>最后一个关键方法<code>broadcast()</code>由<code>PushService</code>中订阅的Redis推送时触发（前提是向Redis订阅了<code>notification</code>这个Topic，使用 <a href="/CS-Note/Redis.html#发布订阅">Redis的发布订阅</a> 功能），用于向用户主动推送通知。当Redis收到<code>PUBLISH</code>调用后，自动触发<code>broadcast()</code>，将<code>String</code>表示的JSON数据推送给所有订阅端（实际上只有一个单例），从而推送给所有WebSocket客户端。</p> <p>对于一个<code>NotificationMessage</code>，如果设置了<code>userId</code>，则推送给指定用户，适用于订单成交等针对用户ID的通知；如果没有设置<code>userId</code>，则推送给所有用户，适用于公开市场信息的推送。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>链路：       广播                 push
      redis <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">PushVerticle</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Verticle</span>组件管理的所有<span class="token class-name">WebSocket</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>整个推送服务仅包括3个Java文件，我们就实现了基于Redis和WebSocket的高性能推送。</p> <h1 id="_6-ui系统"><a href="#_6-ui系统" class="header-anchor">#</a> 6.ui系统</h1> <p>UI系统就是一个标准的Web系统，本质上是一个MVC模型，视图页面都放在<code>src/main/resources/templates/</code>目录下。</p> <p>编写MvcController实现登录，登录成功后，设置一个Cookie代表用户身份，以<code>userId:expiresAt:hash</code>表示。由于计算哈希引入了<code>HmacKey</code>，因此，客户端无法伪造Cookie。：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcController</span> <span class="token keyword">extends</span> <span class="token class-name">LoggerSupport</span> <span class="token punctuation">{</span>
    <span class="token comment">// 显示登录页</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/signin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">signin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">prepareModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;signin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 登录</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/signin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">signIn</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">UserProfileEntity</span> userProfile <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">signin</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 登录成功后设置Cookie:</span>
            <span class="token class-name">AuthToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthToken</span><span class="token punctuation">(</span>userProfile<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> cookieService<span class="token punctuation">.</span><span class="token function">getExpiresInSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cookieService<span class="token punctuation">.</span><span class="token function">setSessionCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 登录失败:</span>
            <span class="token keyword">return</span> <span class="token function">prepareModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;signin&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> email<span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Invalid email or password.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 登录失败:</span>
            <span class="token keyword">return</span> <span class="token function">prepareModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;signin&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> email<span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Internal server error.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 登录成功跳转:</span>
        <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>编写<code>UIFilter</code>，用于验证Cookie并把特定用户的身份绑定到<code>UserContext</code>中：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> resp<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查找Cookie:</span>
        <span class="token class-name">AuthToken</span> auth <span class="token operator">=</span> cookieService<span class="token punctuation">.</span><span class="token function">findSessionCookie</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> auth <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> auth<span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">UserContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserContext</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>编写<code>ProxyFilter</code>，将页面JavaScript对API的调用转发给API系统：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造【一次性】Token:</span>
        <span class="token class-name">String</span> authToken <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AuthToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthToken</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">60_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            authToken <span class="token operator">=</span> <span class="token string">&quot;Bearer &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">toSecureString</span><span class="token punctuation">(</span>hmacKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 转发到API并读取响应：</span>
        <span class="token class-name">String</span> responseJson <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> params <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">convertParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                responseJson <span class="token operator">=</span> tradingApiClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authToken<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                responseJson <span class="token operator">=</span> tradingApiClient<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authToken<span class="token punctuation">,</span>
                        <span class="token function">readBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 写入响应:</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PrintWriter</span> pw <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>responseJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 写入错误响应:</span>
            <span class="token function">writeApiException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 写入错误响应:</span>
            <span class="token function">writeApiException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ApiException</span><span class="token punctuation">(</span><span class="token class-name">ApiError</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>把<code>ProxyFilter</code>挂载到<code>/api/*</code>，通过UI转发请求的目的是简化页面JavaScript调用API，一是不再需要跨域，二是UI已经经过了登录认证，转发过程中自动生成<strong>一次性</strong>Token来调用API，这样JavaScript不再关心如何生成<code>Authorization</code>头。</p> <p>然后编写页面：</p> <ul><li>signin.html：登录页；</li> <li>signup.html：注册页；</li> <li>index.html：交易页。</li></ul> <p>页面功能主要由JavaScript实现，选择Vue前端框架，最终实现效果如下：</p> <img src="/CS-Note/assets/img/snapshot.f3d86e4a.png" alt="snapshot"> <p>最后，在后台注册时，如果检测到本地开发环境，就自动调用内部API给用户添加一些资产，否则新注册用户无法交易。</p> <h1 id="_7-总结"><a href="#_7-总结" class="header-anchor">#</a> 7.总结</h1> <p>以上就完成了一个7x24运行的证券交易系统，虽然实现了基本功能，但仍有很多可改进的地方。</p> <h2 id="网关"><a href="#网关" class="header-anchor">#</a> 网关</h2> <p>直接给用户暴露API和UI是不合适的，通常我们会选择一个反向代理充当网关。可以使用<a href="https://spring.io/projects/spring-cloud-gateway" target="_blank" rel="noopener noreferrer">Spring Cloud Gateway<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来实现网关。Spring Cloud Gateway是基于Netty的异步服务器，允许我们编写一系列过滤器来实现黑名单、权限检查、限流等功能。</p> <p>也可以选择更通用的<a href="https://www.nginx.com/" target="_blank" rel="noopener noreferrer">Nginx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>作为网关，相应的功能则需要由Lua脚本实现，具体可参考<a href="https://openresty.org/" target="_blank" rel="noopener noreferrer">OpenResty<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="远程调用"><a href="#远程调用" class="header-anchor">#</a> 远程调用</h2> <p>在系统内部，我们直接通过HTTP请求实现了远程调用，因为暴露的接口较少。如果接口比较多，可以考虑使用RPC调用，例如<a href="https://spring.io/projects/spring-cloud-openfeign" target="_blank" rel="noopener noreferrer">Spring Cloud OpenFeign<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。Spring Cloud OpenFeign把REST请求封装为Java接口方法，实现了一种声明式的RPC调用。也可以考虑更加通用的<a href="https://grpc.io/" target="_blank" rel="noopener noreferrer">gRPC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="系统监控"><a href="#系统监控" class="header-anchor">#</a> 系统监控</h2> <p>要监控系统状态、性能等实时信息，我们需要构造一个监控系统。从零开始是不现实的，选择一个通用的标准协议比使用JMX要更简单。StatsD就是目前最流行的监控方案，它的基本原理是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>┌ ─ ─ ─ ─ ─ ─ ─ ┐
  ┌───────────┐
│ │Application│ │
  └───────────┘
│       │       │
     UDP│
│       ▼       │
  ┌───────────┐       ┌───────────┐
│ │  StatsD   │─┼────▶│  Server   │
  └───────────┘       └───────────┘
└ ─ ─ ─ ─ ─ ─ ─ ┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>应用程序本身负责收集监控数据，然后以UDP协议发给StatsD守护进程，StatsD进程通常和应用程序运行在同一台机器上，它非常轻量级，并且StatsD是否运行都不影响应用程序的正常运行（因为UDP协议只管发不管能不能收到）。如果StatsD进程在运行中，它就把监控数据实时发送给聚合服务器如<a href="https://graphite.readthedocs.io/" target="_blank" rel="noopener noreferrer">Graphite<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，再以可视化的形式展示出来。</p> <p>StatsD是一个解决方案，既可以自己用开源组件搭建，又可以选择第三方商业服务商，例如<a href="https://www.datadoghq.com/" target="_blank" rel="noopener noreferrer">DataDog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。应用程序自身的数据采集则需要根据使用的服务商确定。如果使用DataDog，它会提供一个<code>dd-java-agent.jar</code>，在启动应用程序时，以agent的方式注入到JVM中：</p> <div class="language-plain line-numbers-mode"><pre class="language-plain"><code>$ java -javaagent:dd-java-agent.jar -jar app.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再通过引入DataDog提供的API：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.datadoghq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dd-trace-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>{version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>就可以实现数据采集。DataDog提供的agent除了能采集应用程序的数据，还可以直接监控JVM、Linux系统，能大大简化监控配置。</p> <p>对于分布式调用，例如UI调用API，API调用Engine，还可以集成<a href="https://spring.io/projects/spring-cloud-sleuth" target="_blank" rel="noopener noreferrer">Spring Cloud Sleuth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来监控链路。它通过在入口调用每次生成一个唯一ID来跟踪链路，采集数据可直接与StatsD集成。</p> <h2 id="密钥管理"><a href="#密钥管理" class="header-anchor">#</a> 密钥管理</h2> <p>对于很多涉及密钥的配置来说，如数据库密码，系统AES密码，管理员口令等，直接存放在配置文件或数据库中都是不安全的。使用专业的密钥管理软件如<a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>可以更安全地管理密钥。<a href="https://spring.io/projects/spring-cloud-vault" target="_blank" rel="noopener noreferrer">Spring Cloud Vault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>就是用于从Vault读取密钥，适合对安全性要求特别高的项目。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/16/2024, 9:00:44 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/CS-Note/assets/js/app.499d959b.js" defer></script><script src="/CS-Note/assets/js/2.3a0ab2ea.js" defer></script><script src="/CS-Note/assets/js/1.2a19e319.js" defer></script><script src="/CS-Note/assets/js/22.8a129fa2.js" defer></script>
  </body>
</html>
